{"version":3,"file":"SoundMng.js","names":["#hSndBuf","val: T_Variable","#volume","#fadebgm","#fadeoutbgm","#fadeoutse","#fadese","#playbgm","#playse","#stop_allse","#stopbgm","#stopse","#wb","#wf","#wl","#ws","#xchgbuf","codecs: {[ext: string]: boolean}","#getSndBuf","#evtMng","#getVol","#initVol"],"sources":["../src/sn/SoundMng.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {type IEvtMng, argChk_Boolean, argChk_Num} from './CmnLib';\nimport type {T_HTag, TArg} from './Grammar';\nimport type {T_Variable, T_Main, T_NoticeChgVolume} from './CmnInterface';\nimport type {Config} from './Config';\nimport type {SysBase} from './SysBase';\nimport {BUF_BGM, BUF_SE, SndBuf, xchgbuf} from './SndBuf';\n\nimport {Howler} from 'howler';\n\n\nexport type HSndBuf = {[buf: string]: SndBuf}\n\n\nexport class SoundMng {\n\t#hSndBuf\t: HSndBuf\t= {};\n\t#getSndBuf(buf: string) {return this.#hSndBuf[buf]}\n\n\tconstructor(cfg: Config, hTag: T_HTag, private readonly val: T_Variable, main: T_Main, sys: SysBase) {\n\t\thTag.volume\t\t= o=> this.#volume(o);\t\t// 音量設定（独自拡張）\n\t\thTag.fadebgm\t= o=> this.#fadebgm(o);\t\t// BGMのフェード\n\t\thTag.fadeoutbgm\t= o=> this.#fadeoutbgm(o);\t// BGMのフェードアウト\n\t\thTag.fadeoutse\t= o=> this.#fadeoutse(o);\t// 効果音のフェードアウト\n\t\thTag.fadese\t\t= o=> this.#fadese(o);\t\t// 効果音のフェード\n\t\thTag.playbgm\t= o=> this.#playbgm(o);\t\t// BGM の演奏\n\t\thTag.playse\t\t= o=> this.#playse(o);\t\t// 効果音の再生\n\t\thTag.stop_allse\t= ()=> this.#stop_allse();\t// 全効果音再生の停止\n\t\thTag.stopbgm\t= o=> this.#stopbgm(o);\t\t// BGM 演奏の停止\n\t\thTag.stopse\t\t= o=> this.#stopse(o);\t\t// 効果音再生の停止\n\t\thTag.wb\t\t\t= o=> this.#wb(o);\t\t\t// BGM フェードの終了待ち\n\t\thTag.wf\t\t\t= o=> this.#wf(o);\t\t\t// 効果音フェードの終了待ち\n\t\thTag.stopfadese\t= ()=> false;\t\t\t\t// 音声フェードの停止（廃止）\n\t\thTag.wl\t\t\t= o=> this.#wl(o);\t\t\t// BGM 再生の終了待ち\n\t\thTag.ws\t\t\t= o=> this.#ws(o);\t\t\t// 効果音再生の終了待ち\n\t\thTag.xchgbuf\t= o=> this.#xchgbuf(o);\t\t// 再生トラックの交換\n\n\t\tval.setVal_Nochk('save', 'const.sn.loopPlaying', '{}');\n\n\t\tconst codecs: {[ext: string]: boolean} = {};\n\t\tfor (const ext of 'aac,caf,dolby,flac,m4a,m4b,mp3,mp4,mpeg,oga,ogg,opus,wav,weba,webm'.split(',')) codecs[ext] = Howler.codecs(ext);\n\t\tval.setVal_Nochk('tmp', 'const.sn.sound.codecs', JSON.stringify(codecs));\n\t\t// - PixiJS Sound\n\t\t// aiff,caf,mid,mp3,mpeg,oga,ogg,opus,wav,wma\n\t\t// - Howl\n\t\t// aac,caf,dolby,flac,m4a,m4b,mp3,mp4,mpeg,oga,ogg,opus,wav,weba,webm\n\n\t\tSndBuf.init(cfg, val, main, sys, buf=> this.#getSndBuf(buf));\n\t}\n\n\t#evtMng\t: IEvtMng;\n\tsetEvtMng(evtMng: IEvtMng) {this.#evtMng = evtMng; SndBuf.setEvtMng(evtMng)}\n\tsetNoticeChgVolume(setGlbVol: T_NoticeChgVolume, setMovVol: T_NoticeChgVolume) {\n\t\tthis.val.defValTrg('sys:sn.sound.global_volume', (_, val)=> {\n\t\t\tconst v = Number(val);\n\t\t\tHowler.volume(v);\n\t\t\tsetGlbVol(v);\n\t\t});\n\t\tthis.val.defValTrg('sys:sn.sound.movie_volume', (_, val)=> setMovVol(Number(val)));\n\n\t\t// 起動時初期値セット\n\t\tthis.val.setVal_Nochk('sys', 'sn.sound.global_volume', <number>this.val.getVal('sys:sn.sound.global_volume', 1));\n\t\tthis.val.setVal_Nochk('sys', 'sn.sound.movie_volume', <number>this.val.getVal('sys:sn.sound.movie_volume', 1));\n\t}\n\n\t//MARK: 音量設定（独自拡張）\n\t#volume(hArg: TArg) {\n\t\tconst {buf = BUF_SE} = hArg;\n\t\tconst vnV = 'const.sn.sound.'+ buf +'.volume';\n\t\tconst arg_vol = this.#getVol(hArg, 1);\n\t\tif (Number(this.val.getVal('sys:'+ vnV)) === arg_vol) return false;\n\n\t\tthis.val.setVal_Nochk('sys', vnV, arg_vol)\t// 基準音量（sys:）\n\t\tthis.val.flush();\t// fadese()内で必ずしも呼ばれないので\n\n\t\t// 再生中音声の一時的音量も変更\n\t\thArg.time = 0;\n\t\thArg.volume = Number(this.val.getVal('save:'+ vnV));\t// 目標音量（save:）\n\t\treturn this.#fadese(hArg);\n\t}\n\t#getVol(hArg: TArg, def: number) {\n\t\tconst vol = argChk_Num(hArg, 'volume', def);\n\t\tif (vol < 0) return 0;\n\t\tif (vol > 1) return 1;\n\t\treturn vol;\n\t}\n\n\t//MARK: BGM/効果音のフェードアウト（loadから使うのでマクロ化禁止）\n\t#fadeoutbgm(hArg: TArg) {hArg.volume = 0; return this.#fadebgm(hArg)}\n\t//MARK: 効果音のフェードアウト（loadから使うのでマクロ化禁止）\n\t#fadeoutse(hArg: TArg) {hArg.volume = 0; return this.#fadese(hArg)}\n\t//MARK: BGMのフェード（loadから使うのでマクロ化禁止）\n\t#fadebgm(hArg: TArg) {hArg.buf = BUF_BGM; return this.#fadese(hArg)}\n\t//MARK: 効果音のフェード\n\t#fadese(hArg: TArg) {\n\t\tconst {buf = BUF_SE} = hArg;\n\t\tthis.#hSndBuf[buf]?.fade(hArg);\n\n\t\treturn false;\n\t}\n\n\t//MARK: BGM の演奏\n\t#playbgm(hArg: TArg) {\n\t\thArg.buf = BUF_BGM;\n\t\thArg.canskip = false;\n\t\targChk_Boolean(hArg, 'loop', true);\n\t\treturn this.#playse(hArg);\n\t}\n\n\t//MARK: 効果音の再生\n\t#playse(hArg: TArg) {\n\t\tconst {buf = BUF_SE} = hArg;\n\t\tthis.#stopse({buf});\n\n\t\t// isSkipping()は此処のみとする。タイミングによって変わる\n\t\tif (argChk_Boolean(hArg, 'canskip', true) && this.#evtMng.isSkipping) return false;\n\n\t\tthis.#initVol();\n\n\t\tconst join = argChk_Boolean(hArg, 'join', true);\n\t\t\t// an時代・瀬戸愛羅さんより https://famibee.blog.fc2.com/blog-entry-106.html\n\t\t\t// デフォルトでjoin=trueの方が初心者に優しい\n\t\tthis.#hSndBuf[buf] = SndBuf.generate(hArg, buf, join);\n\n\t\treturn join;\n\t}\n\t#initVol = ()=> {\n\t\tHowler.volume(Number(this.val.getVal('sys:sn.sound.global_volume', 1)));\n\t\tthis.#initVol = ()=> { /* empty */ };\n\t};\n\n\t//MARK: 全効果音再生の停止\n\t#stop_allse() {\n\t\tfor (const buf of Object.keys(this.#hSndBuf)) this.#stopse({buf});\n\t\tthis.#hSndBuf = {};\n\n\t\tHowler.unload();\n\n\t\treturn false;\n\t}\n\t//MARK: BGM 演奏の停止（loadから使うのでマクロ化禁止）\n\t#stopbgm(hArg: TArg) {hArg.buf = BUF_BGM; return this.#stopse(hArg)}\n\t//MARK: 効果音再生の停止\n\t#stopse(hArg: TArg) {\n\t\tconst {buf = BUF_SE} = hArg;\n\t\tthis.#hSndBuf[buf]?.stopse();\n\n\t\treturn false;\n\t}\n\n\t//MARK: BGM フェードの終了待ち\n\t#wb(hArg: TArg) {hArg.buf = BUF_BGM; return this.#wf(hArg)}\n\n\t//MARK: 効果音フェードの終了待ち\n\t#wf(hArg: TArg) {\n\t\tconst {buf = BUF_SE} = hArg;\n\t\treturn this.#hSndBuf[buf]?.wf(hArg) ?? false;\n\t}\n\n\t//MARK: BGM 再生の終了待ち\n\t#wl(hArg: TArg) {hArg.buf = BUF_BGM; return this.#ws(hArg)}\n\t//MARK: 効果音再生の終了待ち\n\t#ws(hArg: TArg) {\n\t\tconst {buf = BUF_SE} = hArg;\n\t\treturn this.#hSndBuf[buf]?.ws(hArg) ?? false;\n\t}\n\n\t//MARK: 再生トラックの交換\n\t#xchgbuf(hArg: TArg) {\n\t\tconst {buf: buf1 = BUF_SE, buf2 = BUF_SE} = hArg;\n\t\tif (buf1 === buf2) return false;\n\n\t\tconst a = this.#hSndBuf[buf1];\t// 分割代入の変数交換だと noUncheckedIndexedAccess エラーになるので\n\t\tconst b = this.#hSndBuf[buf2];\n\t\t// eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n\t\tif (a) this.#hSndBuf[buf2] = a; else delete this.#hSndBuf[buf2];\n\t\t// eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n\t\tif (b) this.#hSndBuf[buf1] = b; else delete this.#hSndBuf[buf1];\n\n\t\txchgbuf(hArg);\n\n\t\treturn false;\n\t}\n\n\t//MARK: しおりの読込（BGM状態復元）\n\tplayLoopFromSaveObj(all_stop_and_play: boolean): Promise<void>[] {\n\t\tconst lp = String(this.val.getVal('save:const.sn.loopPlaying', '{}'));\n\t\tif (lp === '{}') {this.#stop_allse(); return []}\n/*\n\t\t\t\t\t(Now)#hSndBuf\n\t\t\t\t\tstop\tplay\n\thSaveLP\tstop\t-\t\tstop\t\t--[1]\n\t(to)\tplay\tplay\tstop/play\t--[2]\n\t\t\teq play\tplay\t-\t\t\t--[2]\n*/\n\t\tconst hSaveLP = <{[buf: string]: string}>JSON.parse(lp);\n\t\tif (all_stop_and_play) this.#stop_allse();\n\t\telse for (const [buf, sb] of Object.entries(this.#hSndBuf)) {\n\t\t\t// [1] #hSndBuf（再生中）だが hSaveLP（再生予定） にない buf -> stop\n\t\t\tif (! (buf in hSaveLP)) sb.stopse();\n\t\t}\n\n\t\t// [2] hSaveLP（再生予定）を再生。だが#hSndBuf（再生中）の状況で処理変更\n\t\treturn Object.entries(hSaveLP).map(([buf, fn])=> new Promise(re=> {\n\t\t\tconst sb = this.#hSndBuf[buf]\n\t\t\tif (! all_stop_and_play && sb) {\n\t\t\t\tif (sb.fn === fn) {re(); return}\n\t\t\t\t//sb.stopse({buf});\t// 再生中 fn !== 再生予定 fn なら stop\n\t\t\t\t\t// #playbgm()、#playse() 内で stop するので省略\n\t\t\t}\n\n\t\t\tconst vm = 'save:const.sn.sound.'+ buf +'.';\n\t\t\tconst hArg = {\n\t\t\t\tfn,\n\t\t\t\tbuf,\n\t\t\t\tjoin\t: false,\n\t\t\t\tloop\t: true,\n\t\t\t\tvolume\t: Number(this.val.getVal(vm +'volume')),\n\t\t\t\tstart_ms: Number(this.val.getVal(vm +'start_ms')),\n\t\t\t\tend_ms\t: Number(this.val.getVal(vm +'end_ms')),\n\t\t\t\tret_ms\t: Number(this.val.getVal(vm +'ret_ms')),\n\t\t\t\tfnc\t\t: re,\t// loaded\n\t\t\t};\n\t\t\tif (hArg.buf === BUF_BGM) this.#playbgm(hArg);\n\t\t\telse this.#playse(hArg);\n\t\t}));\n\t}\n\n\tdestroy() {this.#stop_allse()}\n\n}\n"],"mappings":"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"}