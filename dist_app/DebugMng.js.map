{"version":3,"file":"DebugMng.js","names":["#scrItr","#hTag","#title","#spnDbg","sys: SysBase","#st_trace","#log","#trace","#first","#dspDbg"],"sources":["../src/sn/DebugMng.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {CmnLib, getDateStr} from './CmnLib';\nimport type {TArg, TTag, T_HTag} from './Grammar';\nimport type {SysBase} from './SysBase';\nimport type {ScriptIterator} from './ScriptIterator';\n\nexport type T_TRACE = (txt: string, lvl?: 'D'|'W'|'F'|'E'|'I'|'ET')=> void;\n\n\nexport class DebugMng {\n\tstatic\t#scrItr\t: ScriptIterator;\n\tstatic\t#hTag\t: T_HTag;\n\tstatic\t#title\t: TTag;\n\tstatic\t#spnDbg\t: HTMLSpanElement;\n\n\tconstructor(private readonly sys: SysBase, hTag: T_HTag, scrItr: ScriptIterator) {\n\t\tDebugMng.#scrItr = scrItr;\n\t\tDebugMng.#hTag = hTag;\n\t\tDebugMng.#title = hTag.title;\n\t\tDebugMng.myTrace = DebugMng.#st_trace;\n\n\t\t//\tデバッグ・その他\n\t\t//hTag.clearsysvar\t// Variableで定義\t\t\t\t// システム変数の全消去\n\t\t//hTag.clearvar\t\t// Variableで定義\t\t\t\t// ゲーム変数の全消去\n\t\t//hTag.dump_lay\t\t// LayerMngで定義\t\t\t\t// レイヤのダンプ\n\t\t//hTag.dump_val\t\t// Variableで定義\t\t\t\t// 変数のダンプ\n\t\t//hTag.dump_stack\t// ScriptIteratorで定義\t\t\t// スタックのダンプ\n\t\thTag.log\t\t\t= o=> this.#log(o);\t\t\t\t// ログ出力\n\t\t//hTag.reload_script// ScriptIterator.ts内で定義\t// スクリプト再読込\n\t\thTag.trace\t\t\t= o=> this.#trace(o);\t\t\t// デバッグ表示へ出力\n\n\t\tDebugMng.#spnDbg = document.createElement('span');\n\t\tDebugMng.#spnDbg.hidden = true;\n\t\tDebugMng.#spnDbg.textContent = '';\n\t\tDebugMng.#spnDbg.style.cssText =\n\t\t`\tz-index: ${String(Number.MAX_SAFE_INTEGER)};\n\t\t\tposition: absolute; left: 0; top: 0;\n\t\t\tcolor: black;\n\t\t\tbackground-color: rgba(255, 255, 255, 0.7);`\n\t\tdocument.body.appendChild(DebugMng.#spnDbg);\n\t}\n\tdestroy() {\n\t\tDebugMng.#title = ()=> false;\n\t\tdocument.body.removeChild(DebugMng.#spnDbg);\n\n\t\tDebugMng.myTrace = DebugMng.trace_beforeNew;\n\t}\n\n\t// ログ出力\n\t#first = true;\n\t#log(hArg: TArg) {\n\t\tlet dat = '';\n\t\tif (this.#first) {\n\t\t\tthis.#first = false;\n\t\t\tdat = `== ${CmnLib.plat_desc} ==\\n`;\n\t\t}\n\t\tvoid this.sys.appendFile(\n\t\t\tthis.sys.path_downloads +'log.txt',\n\t\t\t`${dat}--- ${getDateStr('-', '_', '')\n\t\t\t} [fn:${DebugMng.#scrItr.scriptFn} line:${String(DebugMng.#scrItr.lineNum)\n\t\t\t}] prj:${this.sys.arg.cur\n\t\t\t// eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n\t\t\t}\\n${hArg.text || `(text is ${String(hArg.text)})`}\\n`,\n\t\t);\n\n\t\treturn false;\n\t}\n\n\t#trace(hArg: TArg) {\n\t\t// eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n\t\tDebugMng.myTrace(hArg.text || `(text is ${String(hArg.text)})`, 'I');\n\n\t\treturn false;\n\t}\n\n\t// private禁止、galleryでエラーになる\n\tstatic readonly trace_beforeNew: T_TRACE = (txt, lvl = 'E')=> {\n\t\tlet mes = `{${lvl}} `+ txt;\n\t\tlet sty = '';\n\t\tswitch (lvl) {\n\t\t\tcase 'D':\tsty = `color:#${CmnLib.isDarkMode ?'49F' :'05A'};`;\tbreak;\n\t\t\tcase 'W':\tsty = 'color:#FF8800;';\tbreak;\n\t\t\tcase 'F':\tsty = 'color:#BB0000;';\tbreak;\n\t\t\tcase 'ET':\tthrow mes;\n\t\t\tcase 'E':\tconsole.error('%c'+ mes, 'color:#FF3300;');\treturn;\n\t\t\tdefault:\tsty = 'color:black;';\tmes = ' '+ mes;\n\t\t}\n\t\tconsole.info('%c'+ mes, sty);\n\t}\n\tstatic myTrace = DebugMng.trace_beforeNew;\n\tstatic strPos = ()=> DebugMng.#scrItr.lineNum > 0\n\t\t? `(fn:${DebugMng.#scrItr.scriptFn} line:${String(DebugMng.#scrItr.lineNum)}) `\n\t\t: '';\n\tstatic readonly\t#st_trace: T_TRACE = (txt, lvl = 'E')=> {\n\t\tlet mes = `{${lvl}} `+ DebugMng.strPos() + txt;\n\t\tDebugMng.#dspDbg(mes, lvl);\n\n\t\tlet sty = '';\n\t\tswitch (lvl) {\n\t\t\tcase 'D':\tsty = `color:#${CmnLib.isDarkMode ?'49F' :'05A'};`;\tbreak;\n\t\t\tcase 'W':\tsty = 'color:#F80;';\tbreak;\n\t\t\tcase 'F':\tsty = 'color:#B00;';\tbreak;\n\t\t\tcase 'ET':\n\t\t\tcase 'E':\tDebugMng.#title({text: txt});\n\t\t\t\t/*if (CmnLib.osName === \"AND\") {\n\t\t\t\t\tconst buf = \"mailto:foo@hoge.co.jp\"\n\t\t\t\t\t\t+ \"?subject=AIRNovel_ERR&body=\"\n\t\t\t\t\t\t+ CmnLib.escapeZenkaku(mes) + \"\\n\"\n\t\t\t\t\t\t+ \"※一部記号は全角表示しています。\";\n\t\t\t\t\tflash.net.navigateToURL(new URLRequest(buf));\n\t\t\t\t}*/\n\t\t\t\tthis.#hTag.dump_lay({});\n\t\t\t\tthis.#hTag.dump_val({});\n\t\t\t\tDebugMng.#scrItr.dumpErrForeLine();\n\t\t\t\tthis.#hTag.dump_stack({});\n\n\t\t\t\tif (lvl === 'ET') throw mes;\n\t\t\t\tconsole.error('%c'+ mes, 'color:#F30;');\treturn;\n\t\t\tdefault:\tsty = '';\tmes = ' '+ mes;\n\t\t}\n\t\tconsole.info('%c'+ mes, sty);\n\t}\n\n\tstatic readonly\t#dspDbg: T_TRACE = (mes, lvl)=> {\n\t\tlet sty = '';\n\t\tswitch (lvl) {\n\t\t\tcase 'D':\tsty = 'color:#05A;';\tbreak;\n\t\t\tcase 'W':\tsty = 'color:#F80;';\tbreak;\n\t\t\tcase 'F':\tsty = 'color:#B00;';\tbreak;\n\t\t\tcase 'ET':\n\t\t\tcase 'E':\tsty = 'color:#F30;';\tbreak;\n\t\t\tdefault:\tsty = '';\n\t\t}\n\t\tDebugMng.#spnDbg.innerHTML += `<span style='${sty}'>${mes}</span><br/>`;\n\t\tDebugMng.#spnDbg.hidden = false;\n\t};\n\n}\n"],"mappings":"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"}