{"version":3,"file":"GrpLayer.js","names":["bg_col: string","btn: Button","hArg: TArg","#appPixi","#idc","#setIdcSp","#laySub","#sBkFn","#csvFn","#sBkFace","#sps","#width","#height","#spTsy","#rtTsy","#fncRender"],"sources":["../src/sn/DesignCast.ts","../src/sn/GrpLayer.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2021-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport type {TArg} from './Grammar';\nimport type {T_PropParser} from './CmnInterface';\nimport type {SysBase} from './SysBase';\nimport type {ScriptIterator} from './ScriptIterator';\nimport type {HPage} from './LayerMng';\nimport type {HPRM} from './AnalyzeTagArg';\nimport type {TxtStage} from './TxtStage';\nimport type {Button} from './Button';\nimport type {GrpLayer} from './GrpLayer';\nimport type {Config} from './Config';\n\nimport type {Application, Text, Sprite} from 'pixi.js';\n\n\nexport class DesignCast {\n\tstatic\tinit(_appPixi: Application, _sys: SysBase, _scrItr: ScriptIterator, _prpPrs: T_PropParser, _cfg: Config, _hPages: HPage) { /* empty */ }\n\tstatic\tcvsResizeDesign() { /* empty */ }\n//\tstatic\treadonly\t#alzTagArg\t= new AnalyzeTagArg;\n\n\n\tconstructor(readonly bg_col: string, readonly isLay = false) {}\n\tdestroy() { /* empty */ }\n\n\tgethArg(): TArg {return this.hArg}\n\tprotected\thArg\t: TArg\t= {};\n\tsethArg(hArg: TArg): void {\n\t\tthis.hArg = hArg;\n\t}\n\n\tsetOther(_hPrm: HPRM) { /* empty */ }\n\n\tadopt(_idcCh: DesignCast) {\t// 養子縁組\n\t}\n\n\tstatic\tenterMode() { /* empty */ }\n\tstatic\tallHide() { /* empty */ }\n\tset visible(_v: boolean) { /* empty */ }\n\tstatic\tleaveMode() { /* empty */ }\n\n\n\tcvsResize() { /* empty */ }\n\tmake() { /* empty */ }\n\tstatic replaceToken(_o: unknown) { /* empty */ }\n\n}\n\n\n// 画像レイヤ\nexport class GrpLayDesignCast extends DesignCast {\n\tconstructor(_ctn: Sprite, _gl: GrpLayer) {super('#29e', true)}\n\tsetSp(_sp: Sprite) { /* empty */ }\n}\n\n// 文字レイヤ\nexport class TxtLayDesignCast extends DesignCast {\n\tconstructor(_ctn: Sprite, _ts: TxtStage) {\n\t\tsuper('#29e', true);\n\t}\n}\n// 文字レイヤ・パディング\nexport class TxtLayPadDesignCast extends DesignCast {\n\tconstructor(_ts: TxtStage) {super('#9e2')}\n}\n\n// 文字レイヤ・ボタン基本\nexport class BtnDesignCast extends DesignCast {\n\tconstructor(protected readonly btn: Button, override readonly hArg: TArg) {\n\t\tsuper('#e92');\n\t}\n}\n// 文字レイヤ・文字ボタン\nexport class TxtBtnDesignCast extends BtnDesignCast {\n\tconstructor(btn: Button, hArg: TArg, _txt: Text) {\n\t\tsuper(btn, hArg);\n\t}\n}\n\n// 文字レイヤ・画像ボタン\nexport class PicBtnDesignCast extends BtnDesignCast {\n\tsetSp(_sp: Sprite) { /* empty */ }\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {Layer, type T_RecordPlayBack_lay} from './Layer';\n\nimport {CmnLib, argChk_Boolean, argChk_Num} from './CmnLib';\nimport type {TArg} from './Grammar';\nimport type {T_Main, T_Variable} from './CmnInterface';\nimport type {Config} from './Config';\nimport type {SysBase} from './SysBase';\nimport type {SoundMng} from './SoundMng';\nimport type {IMakeDesignCast} from './LayerMng';\nimport {GrpLayDesignCast} from './DesignCast';\nimport {SpritesMng} from './SpritesMng';\nimport {Reading} from './Reading';\n\nimport {Sprite, AnimatedSprite, RenderTexture, type Application} from 'pixi.js';\n\n\nexport type T_RP_layGrp = T_RecordPlayBack_lay & {\n\tsBkFn\t: string;\n\tsBkFace\t: string;\n}\n\n\nexport class GrpLayer extends Layer {\n\tstatic\t#appPixi: Application;\n\tstatic\tinit(main: T_Main, cfg: Config, appPixi: Application, sys: SysBase, sndMng: SoundMng, val: T_Variable): void {\n\t\tGrpLayer.#appPixi = appPixi;\n\t\tSpritesMng.init(cfg, val, sys, main, sndMng);\n\t}\n\tstatic\tdestroy() {SpritesMng.destroy()}\n\n\treadonly\t#idc\t= new GrpLayDesignCast(this.ctn, this);\n\tconstructor() {\n\t\tsuper();\n\t\tif (CmnLib.isDbg) {\n\t\t\tthis.#setIdcSp = sp=> this.#idc.setSp(sp);\n\t\t\tthis.cvsResize = ()=> {super.cvsResize(); this.#idc.cvsResize()}\n\t\t}\n\t}\n\t#setIdcSp\t: (sp: Sprite)=> void\t= ()=> { /* empty */ };\n\n\t#csvFn\t\t= '';\n\t#sBkFn\t\t= '';\n\t#sBkFace\t= '';\n\toverride readonly\tlay = (hArg: TArg)=> {\n\t\tconst RPN_GRP_LAY = Reading.procID +`GrpLayer lay name:${this.name_}`;\n\t\tconst ret = this.#laySub(hArg, isStop=> {\n\t\t\tif (isStop) Reading.endProc(RPN_GRP_LAY);\n\t\t});\n\t\tif (ret) Reading.beginProc(RPN_GRP_LAY);\n\t\treturn ret;\n\t}\n\t#laySub(hArg: TArg, resolve: (isStop: boolean)=> void): boolean {\n\t\tconst {fn, face = ''} = hArg;\n\t\tthis.#idc.sethArg(hArg);\n\t\tif (! fn) {\n\t\t\tsuper.lay(hArg);\n\n\t\t\tif (this.ctn.children.length > 0) this.setPos(hArg);\n\t\t\tthis.#sBkFn = '';\n\t\t\tthis.#csvFn = this.#sBkFace = face;\n\t\t\tresolve(false);\n\t\t\treturn false;\n\t\t}\n\n\t\tconst inFn = 'fn' in hArg;\n\t\tconst inFace = 'face' in hArg;\n\n\t\tthis.clearLay({clear_filter: argChk_Boolean(hArg, 'clear_filter', true)});\n\t\tif (inFn) this.#sBkFn = fn;\t// clearLay()後に置く事\n\t\tif (inFace) this.#sBkFace = face;\n\t\tsuper.lay(hArg);\t// filter設定してる場合も\n\n\t\thArg.dx = 0;\n\t\thArg.dy = 0;\n\n\t\tthis.#sps.destroy();\n\t\tthis.#sps = new SpritesMng(\n\t\t\tthis.#csvFn = fn + (face ?','+ face :''),\n\t\t\tthis.ctn,\n\t\t\tsp=> {\n\t\t\t\tif ('width' in hArg || 'height' in hArg) {\n\t\t\t\t\tsp.width = argChk_Num(hArg, 'width', 0);\n\t\t\t\t\tsp.height = argChk_Num(hArg, 'height', 0);\n\t\t\t\t}\n\t\t\t\tthis.#width = sp.width;\n\t\t\t\tthis.#height = sp.height;\n\t\t\t\tLayer.setXY(sp, hArg, this.ctn, true);\n\t\t\t\tLayer.setBlendmode(this.ctn, hArg);\n\t\t\t//\tif (hArg.page === 'fore') this.rsvEvent(sp);\t// ======\n\t\t\t\t\t// [lay page=fore]のみswfアニメ終了イベント発生\n\t\t\t\tthis.#setIdcSp(sp);\n\t\t\t},\n\t\t\tisStop=> resolve(isStop),\n\t\t);\n\t\treturn this.#sps.ret;\n\t}\n\t#sps\t= new SpritesMng;\n\t#width\t= 0;\n\t#height\t= 0;\n\toverride\tget\twidth() {return this.#width}\n\toverride\tget\theight() {return this.#height}\n\n\n\toverride\trenderStart(isSkipping: boolean) {\n\t\tif (isSkipping) {\n\t\t\tconst a = this.ctn.alpha;\n\t\t\tthis.ctn.alpha = 1;\t// 無意味に思えるが、pixi部の挙動が変わるので一度やる\n\t\t\tthis.ctn.alpha = a;\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#spTsy = new Sprite(this.#rtTsy);\n\t\tthis.#spTsy.visible = false;\n\t\tthis.ctn.addChildAt(this.#spTsy, 0);\n\t\tthis.#spTsy.position.set(-this.ctn.x, -this.ctn.y);\n\n\t\tlet fncRenderFore = ()=> {\n\t\t\tconst a = this.ctn.alpha;\n\t\t\tthis.ctn.alpha = 1;\n\t\t\tfor (const s of this.ctn.children) s.visible = true;\n\t\t\tthis.#spTsy.visible = false;\n\t\t\tGrpLayer.#appPixi.renderer.render(this.ctn, {renderTexture: this.#rtTsy});\t// clear: true\n\t\t\tthis.ctn.alpha = a;\n\t\t\tfor (const s of this.ctn.children) s.visible = false;\n\t\t}\n\t\tif (! this.containMovement) {\n\t\t\tconst oldFnc = fncRenderFore;\t// 動きがないなら最初に一度\n\t\t\tfncRenderFore = ()=> {fncRenderFore = ()=> { /* empty */ }; oldFnc()};\n\t\t}\n\t\tthis.#fncRender = ()=> {\n\t\t\tfncRenderFore();\n\t\t\tthis.#spTsy.visible = true;\n\t\t};\n\t\tGrpLayer.#appPixi.ticker.add(this.#fncRender);\n\t}\n\t#rtTsy\t= RenderTexture.create({\n\t\twidth\t: CmnLib.stageW,\n\t\theight\t: CmnLib.stageH,\n\t});\n\t#spTsy\t= new Sprite;\n\t#fncRender = ()=> { /* empty */ };\n\toverride\trenderEnd() {\n\t\tGrpLayer.#appPixi.ticker.remove(this.#fncRender);\n\t\tthis.ctn.removeChild(this.#spTsy);\n\t\tfor (const s of this.ctn.children) s.visible = true;\n\t\tthis.#spTsy.destroy(true);\n\n\t\tthis.#rtTsy = RenderTexture.create({\n\t\t\twidth\t: CmnLib.stageW,\n\t\t\theight\t: CmnLib.stageH,\n\t\t});\n\t}\n\n\n\tsetPos(hArg: TArg): void {\n\t\tLayer.setXY(\n\t\t\tthis.ctn.children[0] ?? this.ctn,\n\t\t\thArg,\n\t\t\tthis.ctn,\n\t\t\ttrue\n\t\t);\n\t}\n\n\t// アニメ・動画を含むか\n\toverride get containMovement() {\n\t\tif (this.#csvFn === '') return false;\n\n\t\tconst c = this.ctn.children;\n\t\treturn this.#csvFn.split(',').some(\n\t\t\t(fn, i)=> c[i] instanceof AnimatedSprite || SpritesMng.getHFn2VElm(fn)\n\t\t);\n\t}\n\n\toverride clearLay(hArg: TArg): void {\n\t\tsuper.clearLay(hArg);\n\t\tthis.#sps.destroy();\n\t\tthis.#sBkFn\t\t= '';\n\t\tthis.#sBkFace\t= '';\n\t\tthis.#csvFn\t\t= '';\n\t}\n\toverride readonly record = ()=> ({...super.record(),\n\t\tsBkFn\t\t: this.#sBkFn,\n\t\tsBkFace\t\t: this.#sBkFace,\n//\t\tidc_hArg\t: this.#idc.gethArg(),\n\t});\n\toverride playback(hLay: T_RP_layGrp, aPrm: Promise<void>[]): void {\n\t\tsuper.playback(hLay, aPrm);\n\t\tif (hLay.sBkFn === '' && hLay.sBkFace === '') {\n\t\t\tthis.#sBkFn\t\t= '';\n\t\t\tthis.#sBkFace\t= '';\n//\t\t\tthis.#idc.sethArg(hLay.idc_hArg);\n\t\t\treturn;\n\t\t}\n\n\t\taPrm.push(new Promise(re=> this.#laySub(\n\t\t\t{fn: hLay.sBkFn, face: hLay.sBkFace, left: hLay.x, top: hLay.y, alpha: hLay.alpha, blendmode: Layer.getNum2Blendmode(hLay.blendMode), rotation: hLay.rotation, scale_x: hLay.scale_x, scale_y: hLay.scale_y},\n\t\t\t_isStop=> {this.ctn.position.set(hLay.x, hLay.y); re()},\n\t\t\t\t// Layer.setXY()の後に再度移動\n\t\t)));\n\t}\n\n\toverride makeDesignCast(gdc: IMakeDesignCast) {\n\t\tif (! this.ctn.visible) return;\n\t\tgdc(this.#idc);\n\t}\n\t//makeDesignCastChildren(_gdc: IMakeDesignCast) {}\n\n\toverride cvsResize() {super.cvsResize()}\n\n\toverride showDesignCast() {this.#idc.visible = true}\n\t//showDesignCastChildren() {}\n\n\toverride readonly dump = ()=> super.dump() +`, \"pic\":\"${this.#csvFn}\"`;\n\n}\n"],"mappings":"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"}