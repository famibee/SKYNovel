{"version":3,"file":"SpritesMng.js","names":["#cfg","#val","#sys","#main","#cachePicMov","#dec2cachePicMov","#cacheAniSpr","#dec2cacheAniSpr","#glbVol","#movVol","#hFn2hve","#evtMng","ctn?: Container","fncFirstComp: IFncCompSpr","fncAllComp: (isStop: boolean)=> void","#addChild","#aSp","#csv2Sprites","#hFace","#hFn2ResAniSpr","aComp: {fn: string, fnc: IFncCompSpr}[]","#mkSprite","#charmVideoElm","#sortAFrameName"],"sources":["../src/sn/SpritesMng.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2023-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {Config} from './Config';\nimport {type IEvtMng, argChk_Boolean, argChk_Num, getFn, int} from './CmnLib';\nimport type {T_Main, T_Variable, SYS_DEC_RET} from './CmnInterface';\nimport {DebugMng} from './DebugMng';\nimport {SEARCH_PATH_ARG_EXT} from './ConfigBase';\nimport type {SysBase} from './SysBase';\nimport type {SoundMng} from './SoundMng';\nimport type {TArg} from './Grammar';\nimport {Layer} from './Layer';\nimport {Reading} from './Reading';\n\nimport {Sprite, type Container, Texture, AnimatedSprite, LoaderResource, utils, Loader, Rectangle, BLEND_MODES} from 'pixi.js';\n\ntype IFncCompSpr = (sp: Sprite)=> void;\n\ntype Iface = {\n\tfn\t\t\t: string;\n\tdx\t\t\t: number;\n\tdy\t\t\t: number;\n\tblendmode\t: number;\n}\ntype Ihface = { [name: string]: Iface; }\n\ntype IResAniSpr = {\n\taTex\t: Texture[];\n\tmeta\t: {\n\t\tanimationSpeed? :number;\n\t};\n}\n\n\nexport class SpritesMng {\n\tstatic\t#cfg\t: Config;\n\tstatic\t#val\t: T_Variable;\n\tstatic\t#sys\t: SysBase;\n\tstatic\t#main\t: T_Main;\n\tstatic\tinit(cfg: Config, val: T_Variable, sys: SysBase, main: T_Main, sndMng: SoundMng) {\n\t\tSpritesMng.#cfg = cfg;\n\t\tSpritesMng.#val = val;\n\t\tSpritesMng.#sys = sys;\n\t\tSpritesMng.#main = main;\n\t\tif (sys.arg.crypto) {\n\t\t\tSpritesMng.#cachePicMov = (r, res, next)=> SpritesMng.#dec2cachePicMov(r, res, next);\n\t\t\tSpritesMng.#cacheAniSpr = (r, res, next)=> SpritesMng.#dec2cacheAniSpr(r, res, next);\n\t\t}\n\n\t\tconst fnc = ()=> {\n\t\t\tconst vol = SpritesMng.#glbVol * SpritesMng.#movVol;\n\t\t\tfor (const v of Object.values(SpritesMng.#hFn2hve)) v.volume = vol;\n\t\t};\n\t\tsndMng.setNoticeChgVolume(\n\t\t\tvol=> {SpritesMng.#glbVol = vol; fnc()},\n\t\t\tvol=> {SpritesMng.#movVol = vol; fnc()}\n\t\t);\n\t}\n\tstatic\t#movVol\t= 1;\n\tstatic\t#glbVol\t= 1;\n\n\tstatic\t#evtMng\t: IEvtMng;\n\tstatic\tsetEvtMng(evtMng: IEvtMng) {SpritesMng.#evtMng = evtMng}\n\n\n\tconstructor(readonly csvFn = '', readonly ctn?: Container, private fncFirstComp: IFncCompSpr = ()=> { /* empty */ }, private fncAllComp: (isStop: boolean)=> void = ()=> { /* empty */ }) {\n\t\tif (! csvFn) return;\n\n\t\tthis.#addChild = ctn ? sp=> {ctn.addChild(sp); this.#aSp.push(sp)} : ()=> { /* empty */ };\n\t\tthis.ret = SpritesMng.#csv2Sprites(\n\t\t\tcsvFn,\n\t\t\tsp=> this.fncFirstComp(sp),\t\t\t// 差し替え考慮\n\t\t\tisStop=> this.fncAllComp(isStop),\t// 差し替え考慮\n\t\t\tsp=> this.#addChild(sp)\t\t\t\t// 差し替え考慮\n\t\t);\n\t}\n\treadonly ret: boolean\t\t= false;\n\t#addChild\t: (sp: Sprite)=> void;\n\t#aSp\t\t: Container[]\t= [];\n\n\tdestroy() {\t\t// これをやるためのクラス、とすら云える\n\t\tthis.fncFirstComp\t= ()=> { /* empty */ };\n\t\tthis.fncAllComp\t\t= ()=> { /* empty */ };\n\t\tthis.#addChild\t\t= sp=> sp.destroy();\n\n\t\tfor (const sp of this.#aSp) {\n\t\t\tSpritesMng.stopVideo(sp.name);\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n\t\t\tsp.parent?.removeChild(sp);\n\t\t\tsp.destroy();\n\t\t}\n\t\tthis.#aSp = [];\n\t}\n\n\tstatic\tdestroy() {\n\t\tSpritesMng.#hFace\t= {};\n\t\tSpritesMng.#hFn2ResAniSpr\t= {};\n\t\t//SpritesMng.#ldrHFn\t= {};\n\t\tSpritesMng.#hFn2hve\t= {};\n\t}\n\n\n\t//static #ldrHFn: {[fn: string]: 1} = {};\n\tstatic\t#csv2Sprites(csv: string, fncFirstComp: IFncCompSpr, fncAllComp: (isStop: boolean)=> void, addChild: (sp: Sprite)=> void): boolean {\n\t\tif (! csv) return false;\n\n\t\tlet needLoad = false;\n\t\tif (csv.startsWith('data:')) {\t// Data URI\n\t\t\tconst fnc = ()=> {\n\t\t\t\tconst sp = Sprite.from(csv);\n\t\t\t\taddChild(sp);\n\t\t\t\tfncFirstComp(sp);\n\t\t\t\tfncAllComp(needLoad);\n\t\t\t};\n\t\t\tif (csv in utils.TextureCache) fnc();\n\t\t\telse {needLoad = true; (new Loader).add(csv, csv).load(fnc)}\n\n\t\t\treturn needLoad;\n\t\t}\n\n\t\tconst aComp: {fn: string, fnc: IFncCompSpr}[] = [];\n\t\tconst ldr = new Loader;\n\t\tfor (const fn0 of csv.split(',')) {\n\t\t\tif (! fn0) throw 'face属性に空要素が含まれます';\n\n\t\t\t// 差分絵を重ねる\n\t\t\tconst {dx, dy, blendmode, fn} = SpritesMng.#hFace[fn0] ?? {\n\t\t\t\tfn\t: fn0,\n\t\t\t\tdx\t: 0,\n\t\t\t\tdy\t: 0,\n\t\t\t\tblendmode\t: BLEND_MODES.NORMAL\n\t\t\t};\n\t\t\taComp.push({fn, fnc: sp=> {\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n\t\t\t\tif (! sp.transform) return;\t// エラー予防\n\t\t\t\tsp.x = dx;\n\t\t\t\tsp.y = dy;\n\t\t\t\tsp.blendMode = blendmode;\n\t\t\t}});\n\n\t\t\tif (fn in SpritesMng.#hFn2ResAniSpr) continue;\n\t\t\tif (fn in utils.TextureCache) continue;\n\t\t\t//if (fn in utils.BaseTextureCache) continue;\t\t// 警告に変化なし\n\t\t\tif (fn in Loader.shared.resources) continue;\n\t\t\t//if (fn in SpritesMng.#ldrHFn) {\n\t\t\t\t// ここに来るという中途半端な状態がある。お陰で警告が出てしまう\n\t\t\t\t// （警告を消そうとする）以下の試みは効かない。直前の if でそもそもここに来ない\n\t\t\t\t//\tTexture.removeFromCache(fn);\n\t\t\t\t//\tdelete utils.TextureCache[fn];\n\t\t\t\t//\tdelete Loader.shared.resources[fn];\n\t\t\t\t// continue;\t// これは厳禁、御法度。\n\t\t\t\t\t// 画像ボタンや文字ボタン背景で同じ画像を、間を置かずロードした場合に最初一つしか表示されなくなる。以下は確認用ギャラリー\n\t\t\t\t\t// http://localhost:8082/index.html?cur=ch_button\n\t\t\t//}\n\t\t\t//SpritesMng.#ldrHFn[fn] = 1;\n\n\t\t\tneedLoad = true;\n\t\t\tconst url = SpritesMng.#cfg.searchPath(fn, SEARCH_PATH_ARG_EXT.SP_GSM);\n\t\t\tconst xt = this.#sys.arg.crypto\n\t\t\t? {xhrType: url.endsWith('.json')\n\t\t\t\t? LoaderResource.XHR_RESPONSE_TYPE.TEXT\n\t\t\t\t: LoaderResource.XHR_RESPONSE_TYPE.BUFFER}\n\t\t\t: {};\n\t\t\tldr.add({...xt, name: fn, url});\n\t\t}\n\t\tconst comp1 = aComp.at(0);\n\t\tif (comp1) comp1.fnc = fncFirstComp;\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tconst fncLoaded = (_: any, hRes: {[fn: string]: LoaderResource})=> {\n\t\t\tfor (const {fn, fnc} of aComp) {\n\t\t\t\tconst sp = SpritesMng.#mkSprite(fn, hRes);\n\t\t\t\tsp.name = fn;\t// 4 Debug?\n\t\t\t\taddChild(sp);\n\t\t\t\tfnc(sp);\n\t\t\t}\n\t\t\tfncAllComp(needLoad);\n\t\t}\n\t\tif (needLoad) {\n\t\t\tldr.use((res, next)=> {\n\t\t\t\ttry {\n\t\t\t\t\tif (res.extension === 'json') {\n\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\t\t\t\t\tvoid this.#sys.dec('json', res.data)\n\t\t\t\t\t\t.then(str=> SpritesMng.#cacheAniSpr(str, res, next));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\t\t\t\tvoid this.#sys.decAB(res.data).then(aiv=> SpritesMng.#cachePicMov(aiv, res, next));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst mes = `画像/動画ロード失敗です fn:${res.name} ${String(e)}`;\n\t\t\t\t\tif (SpritesMng.#evtMng.isSkipping) console.warn(mes); else console.error('%c'+ mes, 'color:#FF3300;');\n\t\t\t\t}\n\t\t\t})\n\t\t\t.load(fncLoaded);\n\t\t}\n\t\telse queueMicrotask(()=> fncLoaded(0, {}));\n\n\t\treturn needLoad;\n\t}\n\tstatic\t#hFace\t\t\t: Ihface\t= {};\n\tstatic\t#hFn2ResAniSpr\t: {[fn: string]: IResAniSpr} = {};\n\n\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tstatic #cachePicMov = (_r: SYS_DEC_RET, {type, name, data}: any, next: ()=> void)=> {\n\t\tswitch (type) {\n\t\t\tcase LoaderResource.TYPE.VIDEO:{\n\t\t\t\tconst hve = <HTMLVideoElement>data;\n\t\t\t\thve.volume = SpritesMng.#glbVol;\n\t\t\t\tSpritesMng.#hFn2hve[name] = SpritesMng.#charmVideoElm(hve);\n\t\t\t}\n\t\t}\n\t\tnext();\n\t}\n\tstatic #sortAFrameName(aFn: string[]): string[] {\n\t\tconst a_base_name = /([^\\d]+)\\d+\\.(\\w+)/.exec(aFn[0] ?? '');\n\t\tif (! a_base_name) return [];\n\n\t\tconst [, d1='', d2=''] = a_base_name;\n\t\tconst is = d1.length;\n\t\tconst ie = -d2.length -1;\n\t\treturn aFn.sort((a, b)=> int(a.slice(is, ie)) > int(b.slice(is, ie)) ?1 :-1);\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tstatic #dec2cachePicMov(r: SYS_DEC_RET, res: any, next: ()=> void) {\n\t\tres.data = r;\n\t\tif (res.extension !== 'bin') next();\n\n\t\tif (r instanceof HTMLImageElement) {\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\t\tvoid Texture.fromLoader(r, res.url, res.name).then(r2=> {\n\t\t\t\tres.texture = r2;\n\t\t\t\t//Texture.addToCache(Texture.from(r), res.name);\n\t\t\t\t// res.texture = Texture.from(r);\n\t\t\t\t\t// でも良いが、キャッシュ追加と、それでcsv2Sprites()内で使用するので\n\t\t\t\tres.type = LoaderResource.TYPE.IMAGE;\n\t\t\t\tnext();\n// console.log(`fn:SpritesMng.ts line:253 res.url:${String(res.url)} res.name:${String(res.name)} src2:${r.src}`);\n\t\t\t\t// res.url:prj/bg/153385d5-24e0-5483-b779-b04f3ea4c901.bin res.name:市場_品物置き場２\n\t\t\t\tURL.revokeObjectURL(r.src);\n\n\t\t\t\t// これをするとタイトル画面から画面遷移でチラチラする\n\t\t\t\t// const fn = String(res.name);\n\t\t\t\t// Texture.removeFromCache(fn);\n\t\t\t\t// // eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n\t\t\t\t// delete utils.TextureCache[fn];\n\t\t\t\t// // eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n\t\t\t\t// delete Loader.shared.resources[fn];\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tif (r instanceof HTMLVideoElement) {\n\t\t\tr.volume = SpritesMng.#glbVol;\n\t\t\tSpritesMng.#hFn2hve[res.name] = SpritesMng.#charmVideoElm(r);\n\n\t\t\tres.type = LoaderResource.TYPE.VIDEO;\n\t\t\t// URL.revokeObjectURL(r.src);\t// 動作確認したい\n\t\t}\n\t\tnext();\n\t}\n\tstatic #charmVideoElm(hve: HTMLVideoElement): HTMLVideoElement {\n\t\t// 【PixiJS】iOSとChromeでAutoPlay可能なビデオSpriteの設定 - Qiita https://qiita.com/masato_makino/items/8316e7743acac514e361\n\t\tif (SpritesMng.#val.getVal('const.sn.needClick2Play')) {\n\t\t\t// ブラウザ実行で、クリックされるまで音声再生が差し止められている状態か。なにかクリックされれば falseになる\n\t\t\tDebugMng.trace_beforeNew(`[lay系] ${DebugMng.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`, 'W');\n\t\t\thve.muted = true;\t// Chrome対応：自動再生を許可させるため。ないと再開時に DOMException\n\t\t}\n\t\thve.setAttribute('playsinline', '');\t// iOS対応\n\t\treturn hve;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tstatic #cacheAniSpr = (_r: string, {type, spritesheet, name, data}: any, next: ()=> void)=> {\n\t\tswitch (type) {\n\t\t\tcase LoaderResource.TYPE.JSON:{\t// switchは必須\n\t\t\t\tconst aFn = <string[]>spritesheet._frameKeys;\n\t\t\t\tSpritesMng.#sortAFrameName(aFn);\n\t\t\t\tSpritesMng.#hFn2ResAniSpr[name] = {\n\t\t\t\t\taTex: aFn.map(fn=> Texture.from(fn)),\n\t\t\t\t\tmeta: <IResAniSpr['meta']>data.meta,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\tnext();\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tstatic #dec2cacheAniSpr(r: string, res: any, next: ()=> void) {\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n\t\tconst {meta, frames} = res.data = JSON.parse(r);\n\t\tres.type = LoaderResource.TYPE.JSON;\n\t\tif (! meta?.image) {next(); return}\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\tconst fn = getFn(meta.image);\n\t\tconst url = SpritesMng.#cfg.searchPath(fn, SEARCH_PATH_ARG_EXT.SP_GSM);\n\t\t(new Loader)\n\t\t.use((res2, next2)=> {\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\t\tvoid this.#sys.decAB(res2.data)\n\t\t\t.then(r2=> {\n\t\t\t\tres2.data = r2;\n\t\t\t\tif (r2 instanceof HTMLImageElement) {\n\t\t\t\t\tres2.type = LoaderResource.TYPE.IMAGE;\n\t\t\t\t\tnext2();\n\t\t\t\t\tURL.revokeObjectURL(r2.src);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tnext2();\n\t\t\t})\n\t\t\t.catch((e: unknown)=> this.#main.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${res2.name} ${String(e)}`, false));\n\t\t})\n\t\t.add({name: fn, url, xhrType: LoaderResource.XHR_RESPONSE_TYPE.BUFFER})\n\t\t.load((ldr, _hRes)=> {\n\t\t\tfor (const {data} of Object.values(ldr.resources)) {\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\t\t\tconst {baseTexture} = Texture.from(data);\n\t\t\t\tconst aFr = Object.values(<{[nm: string]: {\n\t\t\t\t\tframe: {x: number; y: number; w: number; h: number;}\n\t\t\t\t}}>frames);\n\t\t\t\tSpritesMng.#hFn2ResAniSpr[res.name] = {\n\t\t\t\t\taTex: aFr.map(({frame: {x, y, w, h}})=> new Texture(\n\t\t\t\t\t\tbaseTexture,\n\t\t\t\t\t\tnew Rectangle(x, y, w, h),\n\t\t\t\t\t)),\n\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n\t\t\t\t\tmeta,\n\t\t\t\t};\n\t\t\t}\n\t\t\tnext();\n\t\t});\n\t}\n\n\t\tstatic\t#mkSprite(fn: string, hRes: {[fn: string]: LoaderResource}): Sprite {\n\t\t\tconst ras = SpritesMng.#hFn2ResAniSpr[fn];\n\t\t\tif (ras) {\n\t\t\t\tconst asp = new AnimatedSprite(ras.aTex);\n\t\t\t\tasp.animationSpeed = ras.meta.animationSpeed ?? 1.0;\n\t\t\t\tasp.play();\n\t\t\t\treturn asp;\n\t\t\t}\n\t\t\tif (fn in utils.TextureCache) return Sprite.from(fn);\n\t\t\tconst hve = SpritesMng.#hFn2hve[fn];\n\t\t\tif (hve) return Sprite.from(hve);\n\n\t\t\tconst r = hRes[fn];\n\t\t\treturn r ?new Sprite(r.texture) :new Sprite;\n\t\t}\n\tstatic\t#hFn2hve\t: {[fn: string]: HTMLVideoElement} = {};\n\tstatic\tgetHFn2VElm(fn: string) {return SpritesMng.#hFn2hve[fn]}\n\n\tstatic\twv(hArg: TArg): boolean {\n\t\t// 動画ファイル名指定でいいかなと。なぜなら「ループで再生しつつ」\n\t\t// 同ファイル名の別の動画の再生は待ちたい、なんて状況は普通は無いだろうと\n\t\tconst {fn} = hArg;\n\t\tif (! fn) throw 'fnは必須です';\n\t\tconst hve = SpritesMng.#hFn2hve[fn];\n\t\tif (! hve || hve.loop) return false;\n\n\t\tif (SpritesMng.#evtMng.isSkipping || hve.ended) {SpritesMng.stopVideo(fn); return false}\n\n\t\tconst RPN_WV = 'wv fn:'+ fn;\n\t\tconst stop = argChk_Boolean(hArg, 'stop', true);\n\t\tconst fnc = ()=> {if (stop) SpritesMng.stopVideo(fn)};\n\t\tReading.beginProc(RPN_WV, fnc, true, argChk_Boolean(hArg, 'canskip', true) ?fnc: undefined);\n\t\thve.addEventListener('ended', ()=> Reading.notifyEndProc(RPN_WV), {once: true, passive: true});\n\n\t\treturn true;\n\t}\n\n\tstatic\tstopVideo(fn: string) {\n\t\tconst hve = SpritesMng.#hFn2hve[fn];\n\t\tif (! hve) return;\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n\t\tdelete SpritesMng.#hFn2hve[fn];\n\t\thve.pause();\n\t\thve.currentTime = hve.duration;\n\t}\n\n\n\tstatic\tadd_face(hArg: TArg): boolean {\n\t\tconst {name} = hArg;\n\t\tif (! name) throw 'nameは必須です';\n\t\tif (name in SpritesMng.#hFace) throw '一つのname（'+ name +'）に対して同じ画像を複数割り当てられません';\n\n\t\tconst {fn = name} = hArg;\n\t\tSpritesMng.#hFace[name] = {\n\t\t\tfn,\n\t\t\tdx: argChk_Num(hArg, 'dx', 0),\n\t\t\tdy: argChk_Num(hArg, 'dy', 0),\n\t\t\tblendmode: Layer.getBlendmodeNum(hArg.blendmode ?? '')\n\t\t};\n\n\t\treturn false;\n\t}\n//\tstatic\tclearFace2Name(): void {SpritesMng.hFace = {}}\n\n}\n"],"mappings":"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"}