{"version":3,"file":"ScriptIterator.js","sources":["../src/sn/CallStack.ts","../src/sn/ScriptIterator.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport type {IHEvt2Fnc, IValMp} from './CmnInterface';\n\nexport interface ICallStackArg {\n\t':resvToken'?\t: string;\t\t// call元のtoken\n\t':hEvt1Time'\t: IHEvt2Fnc;\t// call元のローカル予約イベント\n\t':hMp'\t\t\t: IValMp;\t\t// call元のmp:\n\t':タグ名'?\t\t: string;\n\t':lenIfStk'\t\t: number;\n}\n\nexport class CallStack {\n\tconstructor(readonly fn = '', readonly idx = 0, readonly csArg: ICallStackArg = {':hEvt1Time': {}, ':hMp': {}, ':lenIfStk': 1}) {}\n\n\treadonly\ttoString = ()=> `[fn:${this.fn}, idx:${this.idx}, csArg:${this.csArg}]`;\n\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {argChk_Boolean, getFn, CmnLib, argChk_Num} from './CmnLib';\nimport type {IHTag, HArg, Script} from './Grammar';\nimport type {IMain, IVariable, IMark, IPropParser} from './CmnInterface';\nimport {Config} from './Config';\nimport {CallStack, type ICallStackArg} from './CallStack';\nimport {Grammar, tagToken2Name_Args, tagToken2Name} from './Grammar';\nimport {AnalyzeTagArg} from './AnalyzeTagArg';\nimport {RubySpliter} from './RubySpliter';\nimport type {EventMng} from './EventMng';\nimport type {LayerMng} from './LayerMng';\nimport {DebugMng} from './DebugMng';\nimport type {SoundMng} from './SoundMng';\nimport type {SysBase} from './SysBase';\nimport {SEARCH_PATH_ARG_EXT} from './ConfigBase';\nimport {disableEvent, enableEvent} from './ReadState';\nimport {CmnTween} from './CmnTween';\n\nimport {Loader} from 'pixi.js';\n\ninterface HScript {\n\t[fn: string]: Script;\n};\n\ninterface ISeek {\n\tidx\t\t: number;\n\tln\t\t: number;\n};\n\n\nconst enum BreakState {Running, Wait, Break, Breaking, Step, Stepping, StepOuting, StepOut};\n\nconst enum SndProcOnLoad {\n\tMINIMAL_STOP,\n\tNO_TOUCH,\n\tALL_STOP_AND_PLAY,\n};\n\n\nexport class ScriptIterator {\n\t#script\t\t: Script\t= {aToken: [''], len: 1, aLNum: [1]};\n\n\t#scriptFn\t= '';\n\tget scriptFn() {return this.#scriptFn}\n\t#idxToken\t= 0;\n\tsubIdxToken() {--this.#idxToken}\n\t#lineNum\t= 0;\n\tget lineNum() {return this.#lineNum}\n\treadonly addLineNum\t= (len: number)=> this.#lineNum += len;\n\tjumpJustBefore() {this.#jumpWork(this.#scriptFn, '', --this.#idxToken)}\n\t\t// 直前にジャンプ\n\n\n\t#aCallStk\t: CallStack[]\t= [];\t// FILOバッファ（push/pop）\n\n\treadonly\t#grm;\n\treadonly\t#alzTagArg\t= new AnalyzeTagArg;\n\n\n\t//MARK: コンストラクタ\n\tconstructor(private readonly cfg: Config, private readonly hTag: IHTag, private readonly main: IMain, private readonly val: IVariable, private readonly prpPrs: IPropParser, private readonly sndMng: SoundMng, private readonly sys: SysBase) {\n\t\t// 変数操作\n\t\thTag.let_ml\t\t= o=> this.#let_ml(o);\t// インラインテキスト代入\n\t\thTag.endlet_ml\t= ()=> false;\t\t\t// インラインテキスト代入終端\n\t\t\t// [if]ブロック内で【未定義のタグ[endlet_ml]です】エラーが発生する対策\n\n\t\t// デバッグ・その他\n\t\thTag.dump_stack\t= ()=> this.#dump_stack();\t// スタックのダンプ\n\t\thTag.dump_script= o=> this.#dump_script(o);\t// スクリプトのダンプ\n\n\t\t// 条件分岐\n\t\thTag['else']\t=\t\t\t\t\t\t\t// その他ifブロック開始\n\t\thTag.elsif\t\t=\t\t\t\t\t\t\t// 別条件のifブロック開始\n\t\thTag.endif\t\t= ()=> this.#endif();\t\t// ifブロックの終端\n\t\thTag['if']\t\t= o=> this.#if(o);\t\t\t// ifブロックの開始\n\n\t\t// ラベル・ジャンプ\n\t\t//hTag.button\t// LayerMng.ts内で定義\t\t// ボタンを表示\n\t\thTag.call\t\t= o=> this.#call(o);\t\t// サブルーチンコール\n\t\thTag.jump\t\t= o=> this.#jump(o);\t\t// シナリオジャンプ\n\t\t//hTag.page\t\t= // ReadState が担当に\t\t// ページ移動\n\t\thTag.pop_stack\t= o=> this.#pop_stack(o);\t// コールスタック破棄\n\t\thTag.return\t\t= o=> this.#return(o);\t\t// サブルーチンから戻る\n\n\t\t// マクロ\n\t\thTag.bracket2macro\t= o=> this.#bracket2macro(o);// 括弧マクロの定義\n\t\thTag.char2macro\t\t= o=> this.#char2macro(o);\t// 一文字マクロの定義\n\t\thTag.endmacro\t\t= o=> this.#return(o);\t\t// マクロ定義の終了\n\t\thTag.macro\t\t\t= o=> this.#macro(o);\t\t// マクロ定義の開始\n\n\t\t// しおり\n\t\t//hTag.copybookmark\t\t// Variable.ts内で定義\t// しおりの複写\n\t\t//hTag.erasebookmark\t// Variable.ts内で定義\t// しおりの消去\n\t\thTag.load\t\t\t= o=> this.#load(o);\t\t\t// しおりの読込\n\t\thTag.reload_script\t= o=> this.#reload_script(o);\t// スクリプト再読込\n\t\thTag.record_place\t= ()=> this.#record_place();\t// セーブポイント指定\n\t\thTag.save\t\t\t= o=> this.#save(o);\t\t\t// しおりの保存\n\n\n\t\tif (cfg.oCfg.debug.token) this.#dbgToken = token=> {if (token.trim() !== '') console.log(`🌱 トークン fn:${this.#scriptFn} idx:${this.#idxToken} ln:${this.#lineNum} token【${token}】`)};\n\n\t\tval.defTmp('const.sn.aIfStk.length', ()=> this.#aIfStk.length);\n\t\tval.defTmp('const.sn.vctCallStk.length', ()=> this.#aCallStk.length);\n\n\t\tthis.#grm = new Grammar(cfg);\n\t\t\n\t\tconst ce = cfg.oCfg.init.escape;\n\t\tthis.#grm.setEscape(ce);\n\t\tRubySpliter.setEscape(ce);\n\n\t\tif (CmnLib.isDbg) {\n\t\t\tsys.addHook((type, o)=> this.#hHook[type]?.(o));\n\t\t\tthis.isBreak = this.#isBreak_base;\n\n\t\t\tconst fnc = this.analyzeInit;\n\t\t\tthis.analyzeInit = ()=> {\n\t\t\t\tthis.analyzeInit = ()=> {};\n\t\t\t\tthis.sys.send2Dbg('hi', {});\n\t\t\t};\n\t\t\tthis.#hHook.auth = o=> {\n\t\t\t\tconst hLineBP = o.hBreakpoint.hFn2hLineBP;\n\t\t\t\tfor (const [fn, v] of Object.entries(hLineBP)) this.#regBreakPoint(fn, <any>v);\n\n\t\t\t\tScriptIterator.#hFuncBP = {};\n\t\t\t\tfor (const v of o.hBreakpoint.aFunc) {\n\t\t\t\t\tScriptIterator.#hFuncBP[v.name] = 1;\n\t\t\t\t}\n\n\t\t\t\tif (o.stopOnEntry) {\n\t\t\t\t\twhile (true) {\n\t\t\t\t\t\tlet tkn = this.nextToken();\n\t\t\t\t\t\tif (! tkn) break;\t// 初期化前に終了した場合向け\n\n\t\t\t\t\t\tconst uc = tkn.charCodeAt(0);\t// TokenTopUnicode\n\t\t\t\t\t\tif (uc === 91) break;\t// [ タグ開始\n\t\t\t\t\t\tif (uc === 38) break;\t// & 変数操作・変数表示\n\t\t\t\t\t\tif (uc === 42 && tkn.length === 1) break;\t// 単文字の *\n\t\t\t\t\t\tif (uc === 10) this.#lineNum += tkn.length;\t// \\n 改行\n\t\t\t\t\t}\n\t\t\t\t\tthis.sys.callHook('stopOnEntry', {});\n\t\t\t\t\tthis.analyzeInit = fnc;\n\t\t\t\t\tthis.analyzeInit();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.noticeWait = ()=> {\n\t\t\t\t\t\tthis.noticeWait = ()=> {};\n\t\t\t\t\t\tthis.sys.callHook('stopOnEntry', {});\t// sn全体へ通知\n\n//\t\t\t\t\t\tthis.sys.callHook('continue', {});\t// sn全体へ通知\n//\t\t\t\t\t\tthis.breakState = BreakState.breaking;\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.analyzeInit = fnc;\n\t\t\t\t\tthis.analyzeInit();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse this.recodeDesign = ()=> {};\n\t\tif (cfg.oCfg.debug.tag) this.#procDebugtag = tag_name=> console.log(`🌲 タグ解析 fn:${this.#scriptFn} idx:${this.#idxToken} ln:${this.#lineNum} %c[${tag_name} %o]`, 'background-color:#30B;', this.#alzTagArg.hPrm);\n\t}\n\tnoticeWait = ()=> {};\n\t#regBreakPoint(fn: string, o: {[ln: number]: any}) {\n\t\tScriptIterator.#hFn2hLineBP[this.#cnvSnPath4Dbg(fn)] = o;\n\t}\n\n\tdestroy() {this.isBreak = ()=> false}\n\n\treadonly #hHook\t: {[type: string]: (o: any)=> void}\t= {\n\t\t//auth: // constructorで\n\t\t//launch:\t// ここでは冒頭停止に間に合わないのでanalyzeInit()で\n\t\tdisconnect: ()=> {\n\t\t\tScriptIterator.#hFn2hLineBP = {};\n\t\t\tScriptIterator.#hFuncBP = {};\n\t\t\tthis.isBreak = ()=> false;\n\n\t\t\tthis.#hHook.continue!({});\n\t\t\tthis.#breakState = BreakState.Running;\n\t\t},\n\t\trestart: ()=> this.isBreak = ()=> false,\n\n\t\t// ブレークポイント登録\n\t\tadd_break: o=> this.#regBreakPoint(o.fn, o.o),\n\t\tdata_break: o=> {\n\t\t\tif (this.#breakState !== BreakState.Running) return;\n\n\t\t\tthis.#breakState = BreakState.Wait;\n\t\t\tthis.main.setLoop(false, `変数 ${o.dataId}【${o.old_v}】→【${o.new_v}】データブレーク`);\n\t\t\tthis.sys.callHook('stopOnDataBreakpoint', {});\t// sn全体へ通知\n\t\t\tthis.sys.send2Dbg('stopOnDataBreakpoint', {});\n\t\t},\n\t\tset_func_break: o=> {\n\t\t\tScriptIterator.#hFuncBP = {};\n\t\t\tfor (const v of o.a) ScriptIterator.#hFuncBP[v.name] = 1;\n\t\t\tthis.sys.send2Dbg(o.ri, {});\n\t\t},\n\n\t\t// 情報問い合わせ系\n\t\tstack: o=> this.sys.send2Dbg(o.ri, {a: this.#aStack()}),\n\t\teval: o=> {this.sys.send2Dbg(o.ri, {v: this.prpPrs.parse(o.txt)})},\n\n\t\t// デバッガからの操作系\n\t\tcontinue: ()=> {\n\t\t\tif (this.#isIdxOverLast()) return;\n\n\t\t\tthis.#idxToken -= this.#idxDx4Dbg;\n\t\t\tthis.#breakState = BreakState.Breaking;\n\t\t\tthis.main.setLoop(true);\n\t\t\tthis.main.resume();\t// jumpループ後などで停止している場合があるので\n\t\t},\n\t\tstepover: o=> this.#go_stepover(o),\n\t\tstepin: ()=> {\n\t\t\tif (this.#isIdxOverLast()) return;\n\n\t\t\tconst tkn = this.#script.aToken[this.#idxToken -this.#idxDx4Dbg];\n\t\t\tthis.sys.callHook(`stopOnStep${this.#REGSTEPIN.test(tkn ?? '') ?'In' :''}`, {});\t// sn全体へ通知\n\n\t\t\tthis.#idxToken -= this.#idxDx4Dbg;\n\t\t\tthis.#breakState = this.#breakState === BreakState.Wait\n\t\t\t\t? BreakState.Step\n\t\t\t\t: BreakState.Stepping;\n\t\t\tthis.main.setLoop(true);\n\t\t\tthis.main.resume();\t// jumpループ後などで停止している場合があるので\n\t\t},\n\t\tstepout: o=> {\n\t\t\tif (this.#isIdxOverLast()) return;\n\n\t\t\tif (this.#aCallStk.length > 0) this.#go_stepout(true);\n\t\t\telse this.#go_stepover(o);\n\t\t},\n\t\tpause: ()=> {\n\t\t\tthis.#breakState = BreakState.Step;\n\t\t\tthis.main.setLoop(false, '一時停止');\n\t\t\tthis.sys.send2Dbg('stopOnStep', {});\n\t\t},\n\t\tstopOnEntry: ()=> {\n\t\t\tthis.#breakState = BreakState.Step;\n\t\t\tthis.main.setLoop(false, '一時停止');\n\t\t\tthis.sys.send2Dbg('stopOnEntry', {});\n\t\t},\n\t};\n\treadonly #cnvSnPath = (fn: string)=> this.cfg.searchPath(fn, SEARCH_PATH_ARG_EXT.SCRIPT);\n\tstatic\treadonly\t#REG4CODE_FN\t= /(.+)\\/crypto_prj\\/([^\\/]+)\\/[^\\.]+(\\.\\w+)/;\t// https://regex101.com/r/Km54EK/1 141 steps (~0ms)\n\treadonly #cnvSnPath4Dbg = (fn: string)=>\n\t\t(this.sys.pathBaseCnvSnPath4Dbg + this.#cnvSnPath(fn))\n\t\t.replace(ScriptIterator.#REG4CODE_FN, `$1/prj/$2/${this.#scriptFn}$3`);\n\tcnvPath4Dbg = (fn: string)=> this.sys.pathBaseCnvSnPath4Dbg + fn.replace('/crypto_prj/', '/prj/');\n\t#go_stepover(o: any) {\n\t\tif (this.#isIdxOverLast()) return;\n\n\t\tconst tkn = this.#script.aToken[this.#idxToken -this.#idxDx4Dbg];\n\t\tif (this.#REGSTEPIN.test(tkn ?? '')) this.#go_stepout(false);\n\t\telse {\n\t\t\tthis.sys.callHook('stopOnStep', {});\t// sn全体へ通知\n\t\t\tthis.#hHook.stepin!(o);\n\t\t}\n\t}\n\t#go_stepout(out: boolean) {\n\t\tthis.sys.callHook(`stopOnStep${out ?'Out' :''}`, {});\t// sn全体へ通知\n\t\tthis.#csDepth_macro_esc = this.#aCallStk.length -(out ?1 :0);\n\t\tthis.#idxToken -= this.#idxDx4Dbg;\n\t\tthis.#breakState = out ?BreakState.StepOut :BreakState.StepOuting;\n\t\tthis.main.setLoop(true);\n\t\tthis.main.resume();\t// jumpループ後などで停止している場合があるので\n\t}\n\t#csDepth_macro_esc\t= 0;\n\tget #idxDx4Dbg() {\n\t\treturn this.#breakState === BreakState.Break\n\t\t\t|| this.#breakState === BreakState.Step ?1 :0\n\t};\n\t#isIdxOverLast(): boolean {\n\t\tif (this.#idxToken < this.#script.len) return false;\n\t\tthis.sys.callHook('stopOnEntry', {});\t// sn全体へ通知\n\t\tthis.main.setLoop(false, 'スクリプト終端です');\n\t\treturn true;\n\t}\n\n\t// reload 再生成 Main に受け渡すため static\n\tstatic\t#hFn2hLineBP: {[fn: string]: {[ln: number]: any}} = {};\n\tstatic\t#hFuncBP: {[tag_name: string]: 1} = {};\n\t#breakState\t= BreakState.Running;\n\t\t// https://raw.githubusercontent.com/famibee/SKYNovel-vscode-extension/master/src/doc/BreakStateSMD.pu\n\tisBreak = (_token: string)=> false;\n\t#isBreak_base(token: string): boolean {\n\t\tswitch (this.#breakState) {\n\t\t\tcase BreakState.StepOuting:\tthis.#subHitCondition();\n\t\t\t\tthis.#breakState = BreakState.StepOut;\tbreak;\n\t\t\tcase BreakState.StepOut:\n\t\t\t\tif (this.#aCallStk.length !== this.#csDepth_macro_esc) break;\n\n\t\t\t\tthis.#breakState = BreakState.Step;\n\t\t\t\tthis.main.setLoop(false, 'ステップ実行');\n\t\t\t\tthis.sys.send2Dbg('stopOnStep', {});\n\t\t\t\treturn true;\t// タグを実行せず、直前停止\n\n\t\t\tcase BreakState.Stepping:\tthis.#subHitCondition();\n\t\t\t\tthis.#breakState = BreakState.Step;\tbreak;\n\t\t\tcase BreakState.Step:\t\tthis.#subHitCondition();\n\t\t\t\tthis.main.setLoop(false, 'ステップ実行');\n\t\t\t\tthis.sys.send2Dbg('stopOnStep', {});\n\t\t\t\treturn true;\t// タグを実行せず、直前停止\n\n\t\t\tcase BreakState.Breaking:\tthis.#subHitCondition();\n\t\t\t\tthis.#breakState = BreakState.Running;\tbreak;\n\n\t\t\tdefault:\n\t\t\t{\t// 関数ブレークポイント\n\t\t\t\tif (tagToken2Name(token) in ScriptIterator.#hFuncBP) {\n\t\t\t\t\tthis.#breakState = BreakState.Break;\n\t\t\t\t\tthis.main.setLoop(false, `関数 ${token} ブレーク`);\n\t\t\t\t\tthis.sys.callHook('stopOnBreakpoint', {});\t// sn全体へ通知\n\t\t\t\t\tthis.sys.send2Dbg('stopOnBreakpoint', {});\n\t\t\t\t\treturn true;\t// タグを実行せず、直前停止\n\t\t\t\t}\n\t\t\t}\n\t\t\t{\t// ブレークポイント\n\t\t\t\tconst bp = ScriptIterator.#hFn2hLineBP[this.#cnvSnPath4Dbg(this.#scriptFn)];\n\t\t\t\tif (! bp) break;\n\t\t\t\tconst o = bp[this.#lineNum];\n\t\t\t\tif (! o) break;\n//console.log(`fn:ScriptIterator.ts line:145 👺 【bs:${this.#breakState} idx:${this.#idxToken} ln:${this.#lineNum} tkn:${this.#script.aToken[this.#idxToken -1]}:】 o:%o`, o);\n\t\t\t\tif (o.condition) {if (! this.prpPrs.parse(o.condition)) break}\n\t\t\t\telse if (('hitCondition' in o) && --o.hitCondition > 0) break;\n\t\t\t\tconst isBreak = this.#breakState === BreakState.Running;\n\t\t\t\tthis.#breakState = BreakState.Break;\n\t\t\t\tthis.main.setLoop(false, isBreak ?(\n\t\t\t\t\t(o.condition ? '条件' :'ヒットカウント') +'ブレーク'\n\t\t\t\t\t) :'ステップ実行');\n\t\t\t\tconst type = isBreak ?'stopOnBreakpoint' :'stopOnStep';\n\t\t\t\tthis.sys.callHook(type, {});\t// sn全体へ通知\n\t\t\t\tthis.sys.send2Dbg(type, {});\n\t\t\t}\n\t\t\t\treturn true;\t// タグを実行せず、直前停止\n\t\t}\n\n\t\treturn false;\t// no break、タグを実行\n\t}\n\t#subHitCondition() {\t// step実行中でbreakしないがヒットカウントだけ減算\n\t\tconst o = ScriptIterator.#hFn2hLineBP[getFn(this.#scriptFn)]?.[this.#lineNum];\n\t\tif (o?.hitCondition) --o.hitCondition;\n\t}\n\n\t#aStack(): {fn: string, ln: number, col: number, nm: string, ma: string}[] {\n\t\tconst idx_n = this.#breakState === BreakState.Breaking ?1 :0;\n\t\tconst tkn0 = this.#script.aToken[this.#idxToken -1 +idx_n]!;\n\n\t\tconst fn0 = this.#cnvSnPath4Dbg(this.#scriptFn);\n\t\tconst tag_name0 = tagToken2Name(tkn0!);\n\t\tconst nm = tag_name0 ?`[${tag_name0}]` :tkn0;\n//console.log(`fn:ScriptIterator.ts aStack breakState:${this.#breakState} idx:${this.#idxToken -1} idx_n:${idx_n} tkn0:${tkn0}: fn0:${fn0} nm:${nm} tkn02:${this.#script.aToken[this.#idxToken -1]}: +tkn02:${this.#script.aToken[this.#idxToken]}:`);\n//console.log(`fn:ScriptIterator.ts     a:%o anum:%o`, this.script.aToken, this.script.aLNum);\n\t\tconst ma = this.val.getVal('mp:const.sn.macro') ?? '{}';\n\t\tif (this.#idxToken === 0) return [{fn: fn0, ln: 1, col: 1, nm, ma: ma,}];\n\n\t\tconst lc0 = this.#cnvIdx2lineCol(this.#script, this.#idxToken);// -1不要\n//console.log(`fn:ScriptIterator.ts     ln:${lc0.ln} col:${lc0.col_s} col2:${this.#script.aLNum[this.#idxToken -1]}`);\n\t\tconst a = [{fn: fn0, ln: lc0.ln, col: lc0.col_s +1, nm: nm, ma: ma}];\n\t\tconst len = this.#aCallStk.length;\n\t\tif (len === 0) return a;\n\n\t\tfor (let i=len -1; i>=0; --i) {\n\t\t\tconst cs = this.#aCallStk[i]!;\n\t\t\tconst st = this.#hScript[cs.fn];\n\t\t\tif (! st) continue;\n\t\t\tconst tkn = st.aToken[cs.idx -1];\n\t\t\tif (! tkn) continue;\n\t\t\tconst lc = this.#cnvIdx2lineCol(st, cs.idx);\t// -1不要\n\n\t\t\tconst tag_name = tagToken2Name(tkn);\n\t\t\ta.push({\n\t\t\t\tfn\t: this.#cnvSnPath4Dbg(cs.fn),\n\t\t\t\tln\t: lc.ln,\n\t\t\t\tcol\t: lc.col_s +1,\n\t\t\t\tnm\t: tag_name ?`[${tag_name}]` :tkn,\n\t\t\t\tma\t: cs.csArg[':hMp']['const.sn.macro'] ?? '{}',\n\t\t\t});\n\t\t}\n\n\t\treturn a;\n\t}\n\n\t// result = true : waitする  resume()で再開\n\t#procDebugtag\t= (_tag_name: string)=> {};\n\t//MARK: タグ解析\n\tタグ解析(tagToken: string): boolean {\n\t\tconst [tag_name, args] = tagToken2Name_Args(tagToken);\n\t\tconst tag_fnc = this.hTag[tag_name];\n\t\tif (! tag_fnc) throw `未定義のタグ【${tag_name}】です`;\n\n\t\tthis.#alzTagArg.parse(args);\n\t\tthis.#procDebugtag(tag_name);\n\n\t\tconst hPrm = this.#alzTagArg.hPrm;\n\t\tif (hPrm.cond) {\n\t\t\tconst cond = hPrm.cond.val;\n\t\t\tif (! cond || cond.startsWith('&')) throw '属性condは「&」が不要です';\n\t\t\tconst p = this.prpPrs.parse(cond);\n\t\t\tconst ps = String(p);\n\t\t\tif (ps === 'null' || ps === 'undefined') return false;\n\t\t\tif (! p) return false;\n\t\t}\n\n\t\tlet hArg: any = {};\n\t\tconst len = this.#aCallStk.length;\n\t\tconst csa: any = len === 0 ?{} :this.#aCallStk[len -1]!.csArg;\n\t\tif (this.#alzTagArg.isKomeParam) {\n\t\t\tif (len === 0) throw '属性「*」はマクロのみ有効です';\n\t\t\thArg = {...csa};\n\t\t}\n\t\thArg[':タグ名'] = tag_name;\n\t// #region タグ位置のコールスタック情報を埋め込むコード（デバッグ用）\n\t/*\t{\n\t\t\tconst lc0 = this.#cnvIdx2lineCol(this.#script, this.#idxToken);\n\t\t\tlet now = `存在位置 fn:${this.#scriptFn} line:${lc0.ln} col:${lc0.col_s +1}`;\n\t\t\thArg[':path'] = now;\n\t\t\tconst len = this.#aCallStk.length;\n\t\t\tif (len > 0) {\n\t\t\t\tfor (let i=len -1; i>=0; --i) {\n\t\t\t\t\tconst cs = this.#aCallStk[i];\n\t\t\t\t\tconst hMp = cs.csArg[':hMp'];\n\t\t\t\t\tconst from_macro_nm = hMp ?hMp[':タグ名'] :undefined;\n\t\t\t\t\tconst call_nm = cs.csArg[':タグ名'] ?? '';\n\t\t\t\t\tconst lc = this.#cnvIdx2lineCol(this.#hScript[cs.fn], cs.idx);\n\t\t\t\t\tnow += ` <- (${len -i}) fn:${cs.fn} line:${lc.ln\n\t\t\t\t\t\t} col:${lc.col_s +1\n\t\t\t\t\t\t}`+ (from_macro_nm ?'（['+ from_macro_nm +']マクロ内）' :' ')+\n\t\t\t\t\t\t`で [${call_nm} ...]をコール`;\n\t\t\t\t}\n\t\t\t}\n\t\t}*/\n\t// #endregion\n\t// #region タグ位置情報を埋め込むコード（デバッグ用）\n//\t\thArg[':path'] = this.#scriptFn;\n//\t\thArg[':ln'] = this.#lineNum;\n\t// #endregion\n\t\t// valやdefの値について。null はありえない。'null'や'undefined' はありえる。\n\t\t// 省略時以外で undefined はない。a=undefined と書いても 'undefined' になる\n\t\tfor (const [arg_nm, {val, def}] of Object.entries(hPrm)) {\n\t\t\tlet v = val;\n\t\t\tif (v?.startsWith('%')) {\n\t\t\t\tif (len === 0) throw '属性「%」はマクロ定義内でのみ使用できます（そのマクロの引数を示す簡略文法であるため）';\n\t\t\t\tconst mac = csa[v.slice(1)];\n\t\t\t\tif (mac) {hArg[arg_nm] = mac; continue}\n\n\t\t\t\tif (def === undefined || def === 'null') continue;\n\t\t\t\t\t// defの'null'指定。%変数が無い場合、タグやマクロに属性を渡さない\n\t\t\t\tv = def;\n\t\t\t}\n\n\t\t\tv = this.prpPrs.getValAmpersand(v ?? '');\n\t\t\tif (v !== 'undefined') {hArg[arg_nm] = v; continue}\n\n\t\t\tif (def === undefined) continue;\n\t\t\tv = this.prpPrs.getValAmpersand(def);\n\t\t\tif (v !== 'undefined') hArg[arg_nm] = v;\n\t\t\t\t// 存在しない値の場合、属性を渡さない\n\t\t}\n\n\t\treturn tag_fnc(hArg);\n\t}\n\n\n\t#evtMng\t: EventMng;\n\t#layMng\t: LayerMng;\n\tsetOtherObj(evtMng: EventMng, layMng: LayerMng): void {\n\t\tthis.#evtMng = evtMng;\n\t\tthis.#layMng = layMng;\n\t}\n\n\n\t//MARK: インラインテキスト代入\n\t#let_ml(hArg: HArg) {\n\t\tconst {name} = hArg;\n\t\tif (! name) throw 'nameは必須です';\n\n\t\tlet ml = '';\n\t\tconst len = this.#script.len;\n\t\tfor (; this.#idxToken<len; ++this.#idxToken) {\n\t\t\tml = this.#script.aToken[this.#idxToken]!;\n\t\t\tif (ml !== '') break;\n\t\t}\n\t\thArg.text = ml;\n\t\thArg.cast = 'str';\n\t\tthis.hTag['let']!(hArg);\n\t\tthis.#idxToken += 2;\n\t\tthis.#lineNum += (ml.match(/\\n/g) ?? []).length;\n\n\t\treturn false;\n\t}\n\n\n\t//MARK: スタックのダンプ\n\t#dump_stack() {\n\t\tif (this.#idxToken === 0) {\n\t\t\tconsole.group(`🥟 [dump_stack] スクリプト現在地 fn:${this.#scriptFn} line:${1} col:${0}`);\n\t\t\tconsole.groupEnd();\n\t\t\treturn false;\n\t\t}\n\n\t\tconst lc0 = this.#cnvIdx2lineCol(this.#script, this.#idxToken);\n\t\tconst now = `スクリプト現在地 fn:${this.#scriptFn} line:${lc0.ln} col:${lc0.col_s +1}`;\n\t\tconsole.group(`🥟 [dump_stack] ${now}`);\n\t\tconst len = this.#aCallStk.length;\n\t\tif (len > 0) {\n\t\t\tconsole.info(now);\n\t\t\tfor (let i=len -1; i>=0; --i) {\n\t\t\t\tconst cs = this.#aCallStk[i]!;\n\t\t\t\tconst hMp = cs.csArg[':hMp'];\n\t\t\t\tconst from_macro_nm = hMp ?hMp[':タグ名'] :undefined;\n\t\t\t\tconst call_nm = cs.csArg[':タグ名'] ?? '';\n\t\t\t\tconst lc = this.#cnvIdx2lineCol(this.#hScript[cs.fn]!, cs.idx);\n\t\t\t\tconsole.info(\n\t\t\t\t\t`${len -i}つ前のコール元 fn:${cs.fn} line:${lc.ln\n\t\t\t\t\t} col:${lc.col_s +1\n\t\t\t\t\t}`+ (from_macro_nm ?'（['+ from_macro_nm +']マクロ内）' :' ')+\n\t\t\t\t\t`で [${call_nm} ...]をコール`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\tconsole.groupEnd();\n\n\t\treturn false;\n\t}\n\t#cnvIdx2lineCol(st: Script, idx: number): {ln: number, col_s: number, col_e: number} {\n\t\tconst ret = {ln: 1, col_s: 0, col_e: 0};\n\t\tif (! st) return ret;\n\n\t\tlet i = idx -1;\n\t\tconst lN = ret.ln = st.aLNum[i]!;\n\t\twhile (st.aLNum[i] === lN) {\n\t\t\tif (! st.aToken[i]!.startsWith('\\n')) {\n\t\t\t\tconst len = st.aToken[i]!.length;\n//console.log(`fn:ScriptIterator.ts line:586 cnvIdx2lineCol tkn:${st.aToken[i]} len:${len} s:${ret.col_s} e:${ret.col_e}`);\n\t\t\t\tif (ret.col_e > 0) ret.col_s += len;\n\t\t\t\tret.col_e += len;\n\t\t\t}\n\t\t\tif (--i < 0) break;\n\t\t}\n\n\t\treturn ret;\n\t}\n\n\n\t//MARK: 外部へスクリプトを表示\n\t#dump_script(hArg: HArg) {\n\t\tconst {set_fnc, break_fnc} = hArg;\n\t\tif (! set_fnc) throw 'set_fncは必須です';\t// スクリプトを返すコールバック\n\n\t\tthis.#fncSet = (globalThis as any)[set_fnc];\n\t\tif (! this.#fncSet) {\n\t\t\tif (argChk_Boolean(hArg, 'need_err', true)) throw `HTML内に関数${set_fnc}が見つかりません`;\n\t\t\tthis.#fncSet = ()=> {};\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.noticeBreak = (goto: boolean)=> {\n\t\t\tif (this.#fnLastBreak !== this.#scriptFn) {\n\t\t\t\tthis.#fnLastBreak = this.#scriptFn;\n\t\t\t\tthis.#fncSet(\n\t\t\t\t\tthis.#hScrCache4Dump[this.#scriptFn] ??= this.#script.aToken.join('')\n\t\t\t\t);\n\t\t\t}\n\t\t\tthis.#fncBreak(this.#lineNum, goto);\n\t\t};\n\t\tthis.noticeBreak(true);\t// 一度目のthis.fncBreak()はスルー（まだ読んでないし）\n\n\t\tif (! break_fnc) return false;\t// Break通知コールバック\n\n\t\tthis.#fncBreak = (globalThis as any)[break_fnc];\n\t\tif (! this.#fncBreak) {\n\t\t\tif (argChk_Boolean(hArg, 'need_err', true)) throw `HTML内に関数${break_fnc}が見つかりません`;\n\t\t\tthis.#fncBreak = ()=> {};\n\t\t}\n\n\t\treturn false;\n\t}\n\t#fncSet: (txt: string)=> void = ()=> {};\n\t#fncBreak: (ln: number, goto: boolean)=> void = ()=> {};\n\t#fnLastBreak = '';\n\t#hScrCache4Dump: {[fn: string]: string;} = {};\n\tnoticeBreak = (_goto: boolean)=> {}\n\n\n\t#dumpErrLine = 5;\n\tdumpErrForeLine() {\n\t\tif (this.#idxToken === 0) {\n\t\t\tconsole.group(`🥟 Error line (from 0 rows before) fn:${this.#scriptFn}`);\n\t\t\tconsole.groupEnd();\n\t\t\treturn;\n\t\t}\n\n\t\tlet s = '';\n\t\tfor (let i=this.#idxToken -1; i>=0; --i) {\n\t\t\ts = this.#script.aToken[i] + s;\n\t\t\tif ((s.match(/\\n/g) ?? []).length >= this.#dumpErrLine) break;\n\t\t}\n\t\tconst a = s.split('\\n').slice(-this.#dumpErrLine);\n\t\tconst len = a.length;\n\t\tconsole.group(`🥟 Error line (from ${len} rows before) fn:${this.#scriptFn}`);\n\t\tconst ln_txt_width = String(this.#lineNum).length;\n\t\tconst lc = this.#cnvIdx2lineCol(this.#script, this.#idxToken);\n\t\tfor (let i=0; i<len; ++i) {\n\t\t\tconst ln = this.#lineNum -len +i +1;\n\t\t\tconst mes = `${String(ln).padStart(ln_txt_width, ' ')}: %c`;\n\t\t\tconst e = a[i]!;\n\t\t\tconst line = (e.length > 75) ?e.slice(0, 75) +'…' :e;\t// 長い場合は後略\n\t\t\tif (i === len -1) console.info(\n\t\t\t\tmes + line.slice(0, lc.col_s) +'%c'+ line.slice(lc.col_s),\n\t\t\t\t'color: black; background-color: skyblue;', 'color: black; background-color: pink;'\n\t\t\t)\n\t\t\telse console.info(mes + line, 'color: black; background-color: skyblue;');\n\t\t}\n\t\tconsole.groupEnd();\n\t\t//console.log('Linkの出力   : %o', 'file:///Volumes/MacHD2/_Famibee/SKYNovel/prj/mat/main.sn');\n\t}\n\n\n\t#aIfStk\t: number[]\t= [-1];\t// 先頭に積む FIFOバッファ（unshift / shift）\n\t//MARK: ifブロックの終端\n\t#endif() {\n\t\tconst t = this.#aIfStk[0];\n\t\tif (! t) throw `this.#aIfStk が異常です`;\n\t\tif (t === -1) throw 'ifブロック内ではありません';\n\n\t\tthis.#idxToken = t;\n\t\tthis.#aIfStk.shift();\t// 最初の要素を取り除く\n\n\t\treturn false;\n\t}\n\t//MARK: ifブロックの開始\n\t#if(hArg: HArg) {\n\t\t//console.log('if idxToken:'+ this.#idxToken);\n\t\tconst {exp} = hArg;\n\t\tif (! exp) throw 'expは必須です';\n\t\tif (exp.startsWith('&')) throw '属性expは「&」が不要です';\n\n\t\tlet cntDepth = 0;\t\t// if深度カウンター\n\t\tlet\tidxGo = this.prpPrs.parse(exp) ?this.#idxToken :-1;\n\t\tconst lnIf = this.#script.aLNum[this.#idxToken];\n\t\tlet zLn = this.#lineNum -(lnIf || 0);\t// ??ではなく。NaN は falsy\n\t\tconst len = this.#script.len;\n\t\tfor (; this.#idxToken<len; ++this.#idxToken) {\n\t\t\tconst ln = this.#script.aLNum[this.#idxToken];\n\t\t\tthis.#script.aLNum[this.#idxToken] = (ln || 0)+ zLn; // ??はNaN不可\n\t\t\tconst tkn = this.#script.aToken[this.#idxToken];\n\t\t\t//console.log(`[if]トークン fn:${this.#scriptFn} lnum:${this.#lineNum} idx:${this.#idxToken} realLn:${this.#script.aLNum[this.#idxToken]} idxGo:${idxGo} cntDepth:${cntDepth} token<${tkn}>`);\n\t\t\tif (! tkn) continue;\n\n\t\t\tconst uc = tkn.charCodeAt(0);\t// TokenTopUnicode\n\t\t\tif (uc === 10) {this.#lineNum += tkn.length; continue}\t// \\n 改行\n\t\t\tif (uc !== 91) continue;\t// [ タグ開始以外\n\n\t\t\tconst [tag_name, args] = tagToken2Name_Args(tkn);\n\t\t\tif (! (tag_name in this.hTag)) throw `未定義のタグ[${tag_name}]です`;\n\t\t\tthis.#alzTagArg.parse(args);\n\n\t\t\tswitch (tag_name) {\n\t\t\tcase 'if':\t++cntDepth; break;\n\n\t\t\tcase 'elsif':\n\t\t\t\tif (cntDepth > 0) break;\n\t\t\t\tif (idxGo > -1) break;\n\n\t\t\t\tconst e = this.#alzTagArg.hPrm.exp?.val;\n\t\t\t\tif (! e) throw 'expは必須です';\n\t\t\t\tif (e.startsWith('&')) throw '属性expは「&」が不要です';\n\t\t\t\tif (this.prpPrs.parse(e)) idxGo = this.#idxToken +1;\n\t\t\t\tbreak;\n\n\t\t\tcase 'else':\n\t\t\t\tif (cntDepth > 0) break;\n\t\t\t\tif (idxGo === -1) idxGo = this.#idxToken +1;\n\t\t\t\tbreak;\n\n\t\t\tcase 'endif':\n\t\t\t\tif (cntDepth > 0) {--cntDepth; break}\n\t\t\t\tif (idxGo === -1) {\n\t\t\t\t\t++this.#idxToken;\n\t\t\t\t\tthis.#script.aLNum[this.#idxToken]! += zLn;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.#aIfStk.unshift(this.#idxToken +1);\t// 先頭に要素追加\n\t\t\t\t\tthis.#idxToken = idxGo;\n\t\t\t\t\tthis.#lineNum = this.#script.aLNum[this.#idxToken]!;\n\t\t\t\t\t\t// +zLn 不要\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tthrow '[endif]がないままスクリプト終端です';\n\t\t//return false;\n\t}\n\n\n\t//MARK: サブルーチンコール\n\t#call(hArg: HArg) {\n\t\tif (! argChk_Boolean(hArg, 'count', false)) this.#eraseKidoku();\n\n\t\tconst {fn} = hArg;\n\t\tif (fn) this.#cnvSnPath(fn);\t// chk only\n\t\tthis.#callSub({...hArg, ':hEvt1Time': this.#evtMng.popLocalEvts()});\n\t\t\t// ':hEvt1Time'の扱いだけは[macro]と異なる\n\n\t\tif (argChk_Boolean(hArg, 'clear_local_event', false)) this.hTag.clear_event!({});\n\t\treturn this.#jumpWork(fn, hArg.label);\n\t}\n\t#callSub(h: any) {\n\t\tconst csa: ICallStackArg = {...h, ':hMp': this.val.cloneMp(), ':lenIfStk': this.#aIfStk.length};\n\t\tthis.#script.aLNum[this.#idxToken] = this.#lineNum;\t// 戻ったときの行番号\n\t\tif (! this.#resvToken) {csa[':resvToken'] = ''; this.#clearResvToken()}\n\t\tthis.#aCallStk.push(new CallStack(this.#scriptFn, this.#idxToken, csa));\n\t\tthis.#aIfStk.unshift(-1);\t// 最初に要素を追加\n\t}\n\n\t//MARK: シナリオジャンプ\n\t#jump(hArg: HArg) {\n\t\tif (! argChk_Boolean(hArg, 'count', true)) this.#eraseKidoku();\n\n\t\tthis.#aIfStk[0] = -1;\n\t\treturn this.#jumpWork(hArg.fn, hArg.label);\n\t}\n\n\t//MARK: コールスタック破棄\n\t#pop_stack(hArg: HArg) {\n\t\tif (argChk_Boolean(hArg, 'clear', false)) this.#aCallStk = [];\n\t\telse if (! this.#aCallStk.pop()) throw '[pop_stack] スタックが空です';\n\t\tthis.#clearResvToken();\n\t\tthis.#aIfStk = [-1];\n\t\tthis.val.setMp({});\n\n\t\treturn false;\n\t}\n\n\t//MARK: サブルーチンから戻る\n\t#return(hArg: HArg) {\n\t\tconst cs = this.#aCallStk.pop();\n\t\tif (! cs) throw '[return] スタックが空です';\n\t\tconst csa = cs.csArg;\n\t\tthis.#aIfStk = this.#aIfStk.slice(-csa[':lenIfStk']);\t// 最初の要素を取り除く\n\n\t\tconst hMp = csa[':hMp'];\t// マクロからの復帰の場合にmp:値も復帰\n\t\tif (hMp) this.val.setMp(hMp);\n\n\t\tconst after_token = csa[':resvToken'];\n\t\tif (after_token) this.nextToken = ()=> {\n\t\t\tthis.#clearResvToken();\n\t\t\treturn after_token;\n\t\t}\n\t\telse this.#clearResvToken();\n\t\tif (csa[':hEvt1Time']) this.#evtMng.pushLocalEvts(csa[':hEvt1Time']);\n\n\t\tconst {fn, label} = hArg;\n\t\tif (fn || label) return this.#jumpWork(fn, label);\n\n\t\tif (cs.fn in this.#hScript) {this.#jump_light(cs); return false}\n\t\treturn this.#jumpWork(cs.fn, '', cs.idx);\t// 確実にスクリプトロードなので\n\t}\n\n\t#resvToken\t= '';\n\t#clearResvToken() {\n\t\tthis.#resvToken = '';\n\t\tthis.nextToken = this.#nextToken_Proc;\n\t}\n\n\n\t#skipLabel = '';\n\t#jumpWork(fn = '', label = '', idx = 0): boolean {\n//console.log(`fn:ScriptIterator.ts %cjumpWork fn:${fn} label:${label} idx:${idx}`, 'background-color:#734e95;');\n\t\tif (! fn && ! label) this.main.errScript('[jump系] fnまたはlabelは必須です');\n\t\tif (label) {\n\t\t\tif (! label.startsWith('*')) this.main.errScript('[jump系] labelは*で始まります');\n\t\t\tthis.#skipLabel = label;\n\t\t\tif (! this.#skipLabel.startsWith('**')) this.#idxToken = idx;\n\t\t}\n\t\telse {\n\t\t\tthis.#skipLabel = '';\n\t\t\tthis.#idxToken = idx;\n\t\t}\n\n\t\tif (! fn) {this.analyzeInit(); return false}\n\t\tif (fn.includes('@')) throw `[jump系] fn には文字「@」は禁止です`;\n\n\t\tconst full_path = this.#cnvSnPath(fn);\n\t\tif (fn === this.#scriptFn) {this.analyzeInit(); return false}\n\t\tthis.#scriptFn = fn;\n\t\tconst st = this.#hScript[fn];\n\t\tif (st) {this.#script = st; this.analyzeInit(); return false}\n\n\t\tdisableEvent();\n\t\tconst ldr = new Loader;\n\t\tlet fp_diff = '';\n\t\ttry {\n\t\t\tfp_diff = this.#cnvSnPath(fn +'@');\n\t\t\t// 派生ファイルが存在する場合\n\t\t\tldr.add({name: fn +':base', url: full_path});\n\t\t\tldr.add({name: fn, url: fp_diff});\n\t\t} catch {\n\t\t\t// 派生ファイルはない\n\t\t\tldr.add({name: fn, url: full_path});\n\t\t}\n\t\tldr.use(async (res, next)=> {\n\t\t\ttry {\n\t\t\t\tres.data = await this.sys.dec(res.extension, res.data);\n\t\t\t} catch (e) {\n\t\t\t\tthis.main.errScript(`[jump系]snロード失敗です fn:${res.name} ${e}`, false);\n\t\t\t}\n\t\t\tnext();\n\t\t})\n\t\t.load((_ldr, hRes)=> {\n\t\t\tif (fp_diff) {\t// 派生ファイルが存在する場合\n\t\t\t\tconst scrBase = hRes[fn +':base']!.data;\n\t\t\t\tconst scrDiff = hRes[fn]!.data;\n\t\t\t\tconst aBase = scrBase.split('\\n');\n\t\t\t\tconst aDiff = scrDiff.split('\\n');\n\t\t\t\tconst lenB = aBase.length;\n\t\t\t\tconst lenD = aDiff.length;\n\t\t\t\t// 【派生スクリプト】の空行へ、【基底スクリプト】の同じ行の内容をコピー\n\t\t\t\tfor (let i=0; i<lenD && i<lenB; ++i) aDiff[i] ||= aBase[i];\n\n\t\t\t\t// 【接尾辞つきファイル】として扱う\n\t\t\t\thRes[fn]!.data = aDiff.join('\\n');\n\t\t\t\tdelete hRes[fn +':base'];\n\t\t\t}\n\n\t\t\tthis.nextToken = this.#nextToken_Proc;\n\t\t\tthis.#lineNum = 1;\n\n\t\t\tthis.#resolveScript(hRes[fn]!.data);\n\t\t\tthis.hTag.record_place!({});\n\t\t\tthis.analyzeInit();\n\t\t\tenableEvent();\n\t\t});\n\n\t\treturn true;\n\t}\n\tprivate\tanalyzeInit(): void {\n//console.log(`%cfn:ScriptIterator.ts line:841 analyzeInit()`, 'color:#3B0;');\n\t\tconst o = this.#seekScript(this.#script, Boolean(this.val.getVal('mp:const.sn.macro.name')), this.#lineNum, this.#skipLabel, this.#idxToken);\n\t\tthis.#idxToken\t= o.idx;\n\t\tthis.#lineNum\t= o.ln;\n\t}\n\n\t// シナリオ解析処理ループ・冒頭処理\n\tnextToken = ()=> '';\t// 初期化前に終了した場合向け\n\t#nextToken_Proc(): string {\n\t\tif (this.#errOverScr()) return '';\n\n\t\tthis.#recordKidoku();\n\n\t\t// トークンの行番号更新\n\t\tthis.#script.aLNum[this.#idxToken] ||= this.#lineNum;\t// ??はNaN不可\n\t\tconst token = this.#script.aToken[this.#idxToken]!;\n\t\tthis.#dbgToken(token);\n\t\t++this.#idxToken;\n\n\t\treturn token;\n\t}\n\t#dbgToken = (_token: string)=> {};\n\t#errOverScr(): boolean {\n\t\tif (this.#idxToken < this.#script.len) return false;\n\t\tthis.main.errScript('スクリプト終端です');\n\t\treturn true;\n\t}\n\n\n\treadonly #REG_NONAME_LABEL\t\t= /(\\*{2,})([^\\|]*)/;\n\treadonly #REG_TOKEN_MACRO_BEGIN\t= /^\\[macro\\s/;\n\treadonly #REG_TOKEN_MACRO_END\t= /^\\[endmacro[\\s\\]]/;\n\t#seekScript(st: Script, inMacro: boolean, ln: number, skipLabel: string, idx: number): ISeek {\n\t\t//console.log(`seekScript (from)inMacro:${inMacro} (from)ln:${ln} (to)skipLabel:${skipLabel}: (to)idx:${idx}`);\n\t\tconst len = st.aToken.length;\n\t\tif (! skipLabel) {\t// ラベルジャンプ以外（先頭から開始）\n\t\t\tif (this.#errOverScr()) return {idx, ln};\n\n\t\t\tif (! st.aLNum[idx]) {\t// NaN、undefined は falsy\n\t\t\t\tln = 1;\n\t\t\t\tfor (let j=0; j<idx; ++j) {\n\t\t\t\t\t// 走査ついでにトークンの行番号も更新\n\t\t\t\t\tst.aLNum[j] ||= ln;\t// ??はNaN不可\n\n\t\t\t\t\tconst tkn = st.aToken[j]!;\n\t\t\t\t\tif (tkn.startsWith('\\n')) ln += tkn.length;\t// \\n 改行\n\t\t\t\t\telse ln += (tkn.match(/\\n/g) ?? []).length;\n\t\t\t\t}\n\t\t\t\tst.aLNum[idx] = ln;\n\t\t\t}\n\t\t\telse ln = st.aLNum[idx];\n\n\t\t\treturn {idx, ln};\n\t\t}\n\n\t\t// 無名ラベルジャンプ\n\t\tst.aLNum[0] = 1;\n\t\tconst a_skipLabel = skipLabel.match(this.#REG_NONAME_LABEL);\n\t\tif (a_skipLabel) {\n\t\t\tskipLabel = a_skipLabel[1]!;\n\t\t\tlet i = idx;\n\t\t\tswitch (a_skipLabel[2]) {\n\t\t\tcase 'before':\n\t\t\t\twhile (st.aToken[--i] !== skipLabel) {\n\t\t\t\t\tif (i === 0) DebugMng.myTrace('[jump系 無名ラベルbefore] '\n\t\t\t\t\t\t+ ln +'行目以前で'+ (inMacro ?'マクロ内に' :'')\n\t\t\t\t\t\t+ 'ラベル【'+ skipLabel +'】がありません', 'ET');\n\t\t\t\t\tif (inMacro && st.aToken[i]!.search(this.#REG_TOKEN_MACRO_BEGIN) > -1) DebugMng.myTrace('[jump系 無名ラベルbefore] マクロ内にラベル【'+ skipLabel +'】がありません', 'ET');\n\t\t\t\t}\n\t\t\t\treturn {idx: i +1, ln: st.aLNum[i]!};\t//\tbreak;\n\n\t\t\tcase 'after':\n\t\t\t\twhile (st.aToken[++i] !== skipLabel) {\n\t\t\t\t\tif (i === len) DebugMng.myTrace('[jump系 無名ラベルafter] '\n\t\t\t\t\t\t+ ln +'行目以後でマクロ内にラベル【'+ skipLabel +'】がありません', 'ET');\n\t\t\t\t\tif (st.aToken[i]!.search(this.#REG_TOKEN_MACRO_END) > -1) DebugMng.myTrace('[jump系 無名ラベルafter] '\n\t\t\t\t\t\t+ ln +'行目以後でマクロ内にラベル【'+ skipLabel +'】がありません', 'ET');\n\t\t\t\t}\n\t\t\t\treturn {idx: i +1, ln: st.aLNum[i]!};\t//\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tDebugMng.myTrace('[jump系] 無名ラベル指定【label='+ skipLabel +'】が間違っています', 'ET');\n\t\t\t}\n\t\t}\n\n\t\t// ラベルジャンプ\n\t\tln = 1;\n\t\tconst reLabel = new RegExp(\n\t\t\t'^'+ skipLabel.replaceAll('*', '\\\\*') +'(?=\\\\s|;|\\\\[|\\\\||$)');\n\t\tlet in_let_ml = false;\n\t\tfor (let i=0; i<len; ++i) {\n\t\t\t// 走査ついでにトークンの行番号も更新\n\t\t\tst.aLNum[i] ||= ln;\t// ??はNaN不可\n\n\t\t\tconst tkn = st.aToken[i]!;\n\t\t\tif (in_let_ml) {\n\t\t\t\tif (this.#grm.testTagEndLetml(tkn)) in_let_ml = false;\n\t\t\t\telse ln += (tkn.match(/\\n/g) ?? []).length;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst uc = tkn.charCodeAt(0);\t// TokenTopUnicode\n\t\t\tif (uc === 10) {ln += tkn.length; continue}\t// \\n 改行\n\t\t\tif (uc === 42) {\t// 42 = *\n\t\t\t\tif (tkn.search(reLabel) > -1) return {idx: i +1, ln};//\tbreak;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (uc !== 91) continue;\t// [ タグ開始\n\n\t\t\tln += (tkn.match(/\\n/g) ?? []).length;\n\t\t\tif (this.#grm.testTagLetml(tkn)) in_let_ml = true;\n\t\t}\n\t\tif (in_let_ml) throw '[let_ml]の終端・[endlet_ml]がありません';\n\n\t\tDebugMng.myTrace(`[jump系] ラベル【${skipLabel}】がありません`, 'ET');\n\t\tthrow 'Dummy';\n\t}\n\n\t#hScript\t: HScript\t= Object.create(null);\t//{} シナリオキャッシュ\n\t#resolveScript(txt: string) {\n\t\tlet mes = '';\n\t\ttry {\n\t\t\tmes = 'ScriptIterator.resolveScript';\n\t\t\tconst scr = this.#grm.resolveScript(txt);\n\t\t\tmes = 'ScriptIterator.replaceScript_Wildcard';\n\t\t\tthis.#replaceScript_Wildcard(scr);\n\t\t\tthis.#hScript[this.#scriptFn] = this.#script = scr;\n\t\t}\n\t\tcatch (e) {\n\t\t\tif (e instanceof Error) mes += `例外 mes=${e.message}(${e.name})`;\n\t\t\telse mes = String(e);\n\t\t\tthis.main.errScript(mes, false);\n\t\t}\n\t\tthis.val.touchAreaKidoku(this.#scriptFn);\n\t}\n\n\t#jump_light(cs: CallStack) {\n\t\t// jumpでは連続マクロでスタックオーバーフローになるので簡易版を\n\t\t// 主に[return]やマクロ終了でジャンプ先がチェック不要な場合用\n\t\t// analyzeInit()とかもジャンプ前にやってて不要だし\n\t\tthis.#scriptFn\t= cs.fn;\n\t\tthis.#idxToken\t= cs.idx;\n\t\tconst st = this.#hScript[this.#scriptFn];\n\t\tif (st) this.#script = st;\n\t\tthis.#lineNum = this.#script.aLNum[cs.idx]!;\n//console.log(`fn:ScriptIterator.ts %cjump_light cs.fn:${cs.fn} cs.idx:${cs.idx} ln:${this.#lineNum}`, 'background-color:#a03b79;');\n\t}\n\n\n\treadonly #REG_WILDCARD\t= /^\\[(call|loadplugin)\\s/;\n\treadonly #REG_WILDCARD2\t= /\\bfn\\s*=\\s*[^\\s\\]]+/;\n\t#replaceScript_Wildcard(scr: Script) {\n\t\tfor (let i=scr.len -1; i>=0; --i) {\n\t\t\tconst token = scr.aToken[i]!;\n\t\t\tif (! this.#REG_WILDCARD.test(token)) continue;\n\n\t\t\tconst [tag_name, args] = tagToken2Name_Args(token);\n\t\t\tthis.#alzTagArg.parse(args);\n\n\t\t\tconst p_fn = this.#alzTagArg.hPrm.fn;\n\t\t\tif (! p_fn) continue;\n\t\t\tconst {val: fn} = p_fn;\n\t\t\tif (! fn || ! fn.endsWith('*')) continue;\n\n\t\t\tscr.aToken.splice(i, 1, '\\t', '; '+ token);\n\t\t\tscr.aLNum.splice(i, 1, NaN, NaN);\n\n\t\t\tconst ext = tag_name === 'loadplugin'\n\t\t\t\t? SEARCH_PATH_ARG_EXT.CSS\n\t\t\t\t: SEARCH_PATH_ARG_EXT.SN;\n\t\t\tconst a = this.cfg.matchPath('^'+ fn.slice(0, -1) +'.*', ext);\n\t\t\tfor (const v of a) {\n\t\t\t\tconst nt = token.replace(\n\t\t\t\t\tthis.#REG_WILDCARD2,\n\t\t\t\t\t'fn='+ decodeURIComponent(getFn(v[ext]!))\n\t\t\t\t);\n\t\t\t\t//console.log('\\t='+ nt +'=');\n\t\t\t\tscr.aToken.splice(i, 0, nt);\n\t\t\t\tscr.aLNum.splice(i, 0, NaN);\n\t\t\t}\n\t\t}\n\t\tscr.len = scr.aToken.length;\n\t}\n\n\n\t#recordKidoku() {\n\t\tconst areas = this.val.touchAreaKidoku(this.#scriptFn);\n\n\t\t// マクロ内やサブルーチンではisKidokuを変更させない\n\t\tif (this.#aCallStk.length > 0) {areas.record(this.#idxToken); return}\n\n\t\tthis.#isKidoku = areas.search(this.#idxToken);\n\t\tthis.val.setVal_Nochk('tmp', 'const.sn.isKidoku', this.#isKidoku);\n\t\tif (this.#isKidoku) return;\n\n\t\tareas.record(this.#idxToken);\n\t\t// saveKidoku()\n\t\t\t// 厳密にはここですべきだが、パフォーマンスに問題があるので\n\t\t\t// クリック待ちを期待できるwait、waitclick、s、l、pタグで\n\t\t\t// saveKidoku()をコール。\n\t}\n\t#isKidoku\t= false;\n\tget isKidoku() {return this.#isKidoku};\n\t#eraseKidoku() {\n\t\tthis.val.getAreaKidoku(this.#scriptFn)?.erase(this.#idxToken);\n\t\tthis.#isKidoku = false;\n\t}\n\tget isNextKidoku(): boolean {\n\t\tlet fn\t= this.#scriptFn;\n\t\tlet idx\t= this.#idxToken;\n\t\tlet len\t= this.#script.len;\n\t\tif (this.#aCallStk.length > 0) {\n\t\t\tconst cs = this.#aCallStk[0]!;\n\t\t\tfn  = cs.fn;\n\t\t\tidx = cs.idx;\n\t\t\tconst st = this.#hScript[fn];\n\t\t\tif (st) len = st.len;\n\t\t}\n\n\t\tconst areas = this.val.getAreaKidoku(fn);\n\t\tif (idx === len) return false;\t// スクリプト終端\n\n\t\t//traceDbg(\"isNextKidoku fn:\"+ fn +\" idx:\"+ idx +\" ret=\"+ (areas.search(idx)));\n\t\t//traceDbg(\"【\"+ vctT[idx-1] +\"】【\"+ vctT[idx] +\"】\");\n\n\t\treturn areas.search(idx);\n\t}\n\n\n\tget normalWait(): number {\n\t\treturn this.#isKidoku\n\t\t? (\n\t\t\tthis.val.tagCh_doWait_Kidoku\n\t\t\t?\tthis.val.tagCh_msecWait_Kidoku\n\t\t\t:\t0\n\t\t)\n\t\t: (\n\t\t\tthis.val.tagCh_doWait\n\t\t\t?\tthis.val.tagCh_msecWait\n\t\t\t:\t0\n\t\t);\n\t}\n\n\n\t//MARK: 括弧マクロの定義\n\t#bracket2macro(hArg: HArg) {\n\t\tthis.#grm.bracket2macro(hArg, this.hTag, this.#script, this.#idxToken);\n\n\t\treturn false;\n\t}\n\n\t//MARK: 一文字マクロの定義\n\t#char2macro(hArg: HArg) {\n\t\tthis.#grm.char2macro(hArg, this.hTag, this.#script, this.#idxToken);\n\n\t\treturn false;\n\t}\n\n\t//MARK: マクロ定義の開始\n\treadonly\t#REG_NG4MAC_NM = /[\"'#;\\\\]　]+/;\n\t#macro(hArg: HArg) {\n\t\tconst {name} = hArg;\n\t\tif (! name) throw 'nameは必須です';\n\t\tif (name in this.hTag) throw `[${name}]はタグかすでに定義済みのマクロです`;\n\t\tif (this.#REG_NG4MAC_NM.test(name)) throw `[${name}]はマクロ名として異常です`;\n\n\t\tconst ln = this.#lineNum;\n\t\tconst cs = new CallStack(this.#scriptFn, this.#idxToken);\n\t\tthis.#strStepin += '|'+ name;\n\t\tthis.#REGSTEPIN = new RegExp(`\\\\[(${this.#strStepin})\\\\b`);\n\t\tthis.hTag[name] = hArgM=> {\n\t\t\thArgM.design_unit = hArg.design_unit;\n\t\t\tthis.#callSub(hArgM);\n\n\t\t\t// AIRNovelの仕様：親マクロが子マクロコール時、*がないのに値を引き継ぐ\n\t\t\t//for (const k of Object.keys(hArg)) this.val.setVal_Nochk('mp', k, hArg[k]);\n\t\t\tthis.val.setMp(hArgM as any);\n\t\t\tthis.val.setVal_Nochk('mp', 'const.sn.macro', JSON.stringify({\n\t\t\t\tname: hArg.name,\n\t\t\t}));\t// ムダに大きいスクリプター用情報を削除\n\t\t\tthis.val.setVal_Nochk('mp', 'const.sn.me_call_scriptFn', this.#scriptFn);\n\n\t\t\tthis.#lineNum = ln;\n\t\t\tthis.#jump_light(cs);\n\n\t\t\treturn false;\n\t\t};\n\n\t\tfor (; this.#idxToken < this.#script.len; ++this.#idxToken) {\n\t\t\t// トークンの行番号更新\n\t\t\tthis.#script.aLNum[this.#idxToken] ||= this.#lineNum; // ??はNaN不可\n\n\t\t\tconst token = this.#script.aToken[this.#idxToken]!;\n\t\t\tif (token.search(this.#REG_TOKEN_MACRO_END) > -1) {\n\t\t\t\t++this.#idxToken;\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst uc = token.charCodeAt(0);\t// TokenTopUnicode\n\t\t\tif (uc === 10) this.#lineNum += token.length;\t// \\n 改行\n\t\t\telse if (uc === 91) this.#lineNum += (token.match(/\\n/g) ?? []).length;\t// [ タグ開始\n\t\t}\n\t\tthrow `マクロ[${name}]定義の終端・[endmacro]がありません`;\n\t}\n\t#strStepin\t= 'call';\n\t#REGSTEPIN\t= /\\[(call)\\b/;\t// https://regex101.com/r/Lk9ASK/1\n\n\n\t//MARK: しおりの読込\n\t#load(hArg: HArg) {\n\t\tif (('fn' in hArg) !== ('label' in hArg)) throw 'fnとlabelはセットで指定して下さい';\n\n\t\tconst place = argChk_Num(hArg, 'place', 0);\n\t\tconst mark = this.val.getMark(place);\n\n\t\treturn this.loadFromMark(hArg, mark, SndProcOnLoad.ALL_STOP_AND_PLAY);\n\t}\n\tloadFromMark(hArg: HArg, mark: IMark, snd: SndProcOnLoad = SndProcOnLoad.MINIMAL_STOP) {\n\t\tthis.hTag.clear_event!({});\n\t\tthis.val.mark2save(mark);\n\t\tthis.val.setMp({});\n\t\tthis.#layMng.recPagebreak();\n\n\t\tlet ap: Promise<void>[] = [];\n\t\tif (snd !== SndProcOnLoad.NO_TOUCH) ap = this.sndMng\n\t\t.playLoopFromSaveObj(snd === SndProcOnLoad.ALL_STOP_AND_PLAY);\n\n\t\tif (argChk_Boolean(hArg, 'do_rec', true)) this.#mark = {\n\t\t\thSave\t: this.val.cloneSave(),\n\t\t\thPages\t: {...mark.hPages},\n\t\t\taIfStk\t: [...mark.aIfStk],\n\t\t}\n\n\t\tconst o: HArg = {\n\t\t\tenabled\t: this.val.getVal('save:const.sn.autowc.enabled'),\n\t\t\ttext\t: this.val.getVal('save:const.sn.autowc.text'),\n\t\t\ttime\t: Number(this.val.getVal('save:const.sn.autowc.time')),\n\t\t};\n\t\tthis.hTag.autowc!(o);\n\n\t\tthis.#aIfStk = [...this.#mark.aIfStk];\n\t\tthis.#aCallStk = [];\n\t\tCmnTween.stopAllTw();\n\n\t\tconst p = Promise.allSettled([...ap, ...this.#layMng.playback(this.#mark.hPages)])\n\t\t.then(()=> this.#layMng.cover(false))\n\t\t.catch(e=> console.error(`fn:ScriptIterator.ts loadFromMark e:%o`, e));\n\t\tconst {index, fn} = hArg;\n\t\tif (index) {\t// ページ移動用\n//console.log(`fn:ScriptIterator.ts \\x1b[42mmove!\\x1b[49m fn:${fn} idx:${index}`);\n\t\t\tp.then(()=> this.#jumpWork(fn, '', index));\n\t\t\treturn true;\n\t\t}\n\n\t\tthis.#layMng.cover(true);\t// ページ移動では全画面黒で覆わない\n\t\tdisableEvent();\n\t\tconst fn2 = String(this.val.getVal('save:const.sn.scriptFn'));\n\t\tconst idx = Number(this.val.getVal('save:const.sn.scriptIdx'));\n\t\tdelete this.#hScript[fn2];\t// 必ずスクリプトを再読込。吉里吉里に動作を合わせる\n\t\tconst {label} = hArg;\n\t\tif (label) p.then(()=> {\n\t\t\tthis.#scriptFn = fn2;\n\t\t\tthis.#idxToken = idx;\n\t\t\tthis.hTag.call!({fn, label});\n\t\t});\n\t\telse p.then(()=> this.#jumpWork(fn2, '', idx));\n\n\t\treturn true;\n\t}\n\n\t//MARK: スクリプト再読込\n\t#reload_script(hArg: HArg) {\t// 最後の[record_place]から再開\n\t\tconst mark = this.val.getMark(0);\n\t\t// 起動から再読込までの間に追加・変更・削除されたファイルがあるかも、に対応\n\t\t//\tdelete this.hScript[this.#scriptFn];\t// これだと[reload_script]位置になる\n\t\tdelete this.#hScript[getFn(mark.hSave['const.sn.scriptFn'])];\n\n\t\t// 派生ファイルを削除\n\t\tconst h: HScript = {};\n\t\tfor (const fn in this.#hScript) {\n\t\t\ttry {this.#cnvSnPath(fn +'@')}\n\t\t\tcatch {h[fn] = this.#hScript[fn]!}\t// 派生ファイル以外を残す\n\t\t}\n\t\tthis.#hScript = h;\n\n\t\thArg.do_rec = false;\n\t\treturn this.loadFromMark(hArg, mark, SndProcOnLoad.NO_TOUCH);\n\t}\n\n\n\t//MARK: セーブポイント指定\n\t#mark: IMark = {\n\t\thSave\t: {},\n\t\thPages\t: {},\n\t\taIfStk\t: [-1],\n\t};\n\t#record_place() {\n\t\tif (this.main.isDestroyed()) return false;\n\n\t\tconst {fn, idx} = this.nowScrIdx();\n\t\tthis.val.setVal_Nochk('save', 'const.sn.scriptFn', fn);\n\t\tthis.val.setVal_Nochk('save', 'const.sn.scriptIdx', idx);\n\t\tthis.#mark = {\n\t\t\thSave\t: this.val.cloneSave(),\n\t\t\thPages\t: this.#layMng.record(),\n\t\t\taIfStk\t: this.#aIfStk.slice(this.#aCallStk.length),\n\t\t};\n\n\t\treturn false;\n\t}\n\tnowScrIdx(): {fn: string, idx: number} {\n\t\tconst len = this.#aCallStk.length;\n\t\tif (len === 0) return {\n\t\t\tfn\t: this.#scriptFn,\n\t\t\tidx\t: this.#idxToken,\n\t\t};\n\n\t\tconst cs = this.#aCallStk[0]!;\n\t\treturn {\n\t\t\tfn\t: cs.fn,\n\t\t\tidx\t: cs.idx,\n\t\t}\n\t}\n\tnowMark(): IMark {return {...this.#mark}}\n\n\t//MARK: スクリプト停止位置（マクロなどなら最上位の呼び元）\n\tnowScrFnLn(): {fn: string, ln: number, col_s: number, col_e: number} {\n\t\tconst {fn, idx} = this.nowScrIdx();\n\t\tconst st = this.#hScript[fn]!;\n\t\tconst o = this.#cnvIdx2lineCol(st, idx);\t// -1不要\n\t\treturn {fn, ...o};\n\t}\n\n\t//MARK: しおりの保存\n\t#save(hArg: HArg) {\n\t\tif (! ('place' in hArg)) throw 'placeは必須です';\n\t\tconst place = Number(hArg.place);\n\n\t\tdelete hArg[':タグ名'];\n\t\tdelete hArg.place;\n\t\thArg.text = hArg.text ?? '';\n\t\tthis.#mark.json = hArg;\n\t\tthis.val.setMark(place, this.#mark);\n\n\t\tconst now_sp = Number(this.val.getVal('sys:const.sn.save.place'));\n\t\tif (place === now_sp) this.val.setVal_Nochk('sys', 'const.sn.save.place', now_sp +1);\n\n\t\treturn false;\n\t}\n\n\n\trecodeDesign(hArg: HArg) {\n\t\tlet fn = '';\n\t\tlet idx = 0;\n\n\t\tconst len = this.#aCallStk.length;\n\t\tif (hArg.design_unit && len > 0) {\n\t\t\t// デザインモードでこのマクロへの引数変更とするか（内部をサーチさせない）\n\t\t\tconst cs = this.#aCallStk[0]!;\n\t\t\tfn = cs.fn;\n\t\t\tidx = cs.idx;\n\t\t}\n\t\telse {\n\t\t\tfn = this.#scriptFn;\n\t\t\tidx = this.#idxToken;\n\t\t}\n\t\thArg[':path']\t= this.#cnvSnPath4Dbg(fn);\n\t\tconst scr = this.#hScript[fn]!;\n\t\tconst lc = this.#cnvIdx2lineCol(scr, idx);\n\t\thArg[':ln']\t\t= lc.ln;\n\t\thArg[':col_s']\t= lc.col_s;\n\t\thArg[':col_e']\t= lc.col_e;\n\t\tconst idx_1 = idx -1;\n\t\thArg[':idx_tkn']= idx_1;\n\t\thArg[':token']\t= scr.aToken[idx_1];\n\n\t\tthis.sys.send2Dbg('_recodeDesign', hArg);\n\t}\n\treplace(idx: number, val: string) {this.#script.aToken[idx] = val}\n\n}\n"],"names":["CallStack","fn","idx","csArg","ScriptIterator","cfg","hTag","main","val","prpPrs","sndMng","sys","o","#let_ml","#dump_stack","#dump_script","#endif","#if","#call","#jump","#pop_stack","#return","#bracket2macro","#char2macro","#macro","#load","#reload_script","#record_place","#save","#dbgToken","token","#scriptFn","#idxToken","#lineNum","#aIfStk","#aCallStk","#grm","Grammar","ce","RubySpliter","CmnLib","type","#hHook","#isBreak_base","fnc","hLineBP","v","#regBreakPoint","#hFuncBP","tkn","uc","#procDebugtag","tag_name","#alzTagArg","#script","len","#jumpWork","AnalyzeTagArg","#hFn2hLineBP","#cnvSnPath4Dbg","#breakState","#aStack","#isIdxOverLast","#idxDx4Dbg","#go_stepover","#REGSTEPIN","#go_stepout","#cnvSnPath","SEARCH_PATH_ARG_EXT","#REG4CODE_FN","out","#csDepth_macro_esc","_token","#subHitCondition","tagToken2Name","bp","isBreak","getFn","idx_n","tkn0","fn0","tag_name0","nm","ma","lc0","#cnvIdx2lineCol","a","i","cs","st","#hScript","lc","_tag_name","tagToken","args","tagToken2Name_Args","tag_fnc","hPrm","cond","p","ps","hArg","csa","arg_nm","def","mac","#evtMng","#layMng","evtMng","layMng","name","ml","now","hMp","from_macro_nm","call_nm","ret","lN","set_fnc","break_fnc","#fncSet","argChk_Boolean","goto","#fnLastBreak","#hScrCache4Dump","#fncBreak","_goto","#dumpErrLine","s","ln_txt_width","ln","mes","line","exp","cntDepth","idxGo","lnIf","zLn","e","#eraseKidoku","#callSub","h","#resvToken","#clearResvToken","after_token","label","#jump_light","#nextToken_Proc","#skipLabel","full_path","disableEvent","ldr","Loader","fp_diff","res","next","_ldr","hRes","scrBase","scrDiff","aBase","aDiff","lenB","lenD","#resolveScript","enableEvent","#seekScript","#errOverScr","#recordKidoku","#REG_NONAME_LABEL","#REG_TOKEN_MACRO_BEGIN","#REG_TOKEN_MACRO_END","inMacro","skipLabel","j","a_skipLabel","DebugMng","reLabel","in_let_ml","txt","scr","#replaceScript_Wildcard","#REG_WILDCARD","#REG_WILDCARD2","p_fn","ext","nt","areas","#isKidoku","#REG_NG4MAC_NM","#strStepin","hArgM","place","argChk_Num","mark","snd","ap","#mark","CmnTween","index","fn2","now_sp","idx_1"],"mappings":"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"}