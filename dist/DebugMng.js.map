{"version":3,"file":"DebugMng.js","sources":["../src/sn/DebugMng.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {CmnLib, getDateStr} from './CmnLib';\nimport type {TArg, TTag, T_HTag} from './Grammar';\nimport type {SysBase} from './SysBase';\nimport type {ScriptIterator} from './ScriptIterator';\n\nexport type T_TRACE = (txt: string, lvl?: 'D'|'W'|'F'|'E'|'I'|'ET')=> void;\n\n\nexport class DebugMng {\n\tstatic\t#scrItr\t: ScriptIterator;\n\tstatic\t#hTag\t: T_HTag;\n\tstatic\t#title\t: TTag;\n\tstatic\t#spnDbg\t: HTMLSpanElement;\n\n\tconstructor(private readonly sys: SysBase, hTag: T_HTag, scrItr: ScriptIterator) {\n\t\tDebugMng.#scrItr = scrItr;\n\t\tDebugMng.#hTag = hTag;\n\t\tDebugMng.#title = hTag.title;\n\t\tDebugMng.myTrace = DebugMng.#st_trace;\n\n\t\t//\tデバッグ・その他\n\t\t//hTag.clearsysvar\t// Variableで定義\t\t\t\t// システム変数の全消去\n\t\t//hTag.clearvar\t\t// Variableで定義\t\t\t\t// ゲーム変数の全消去\n\t\t//hTag.dump_lay\t\t// LayerMngで定義\t\t\t\t// レイヤのダンプ\n\t\t//hTag.dump_val\t\t// Variableで定義\t\t\t\t// 変数のダンプ\n\t\t//hTag.dump_stack\t// ScriptIteratorで定義\t\t\t// スタックのダンプ\n\t\thTag.log\t\t\t= o=> this.#log(o);\t\t\t\t// ログ出力\n\t\t//hTag.reload_script// ScriptIterator.ts内で定義\t// スクリプト再読込\n\t\thTag.trace\t\t\t= o=> this.#trace(o);\t\t\t// デバッグ表示へ出力\n\n\t\tDebugMng.#spnDbg = document.createElement('span');\n\t\tDebugMng.#spnDbg.hidden = true;\n\t\tDebugMng.#spnDbg.textContent = '';\n\t\tDebugMng.#spnDbg.style.cssText =\n\t\t`\tz-index: ${String(Number.MAX_SAFE_INTEGER)};\n\t\t\tposition: absolute; left: 0; top: 0;\n\t\t\tcolor: black;\n\t\t\tbackground-color: rgba(255, 255, 255, 0.7);`\n\t\tdocument.body.appendChild(DebugMng.#spnDbg);\n\t}\n\tdestroy() {\n\t\tDebugMng.#title = ()=> false;\n\t\tdocument.body.removeChild(DebugMng.#spnDbg);\n\n\t\tDebugMng.myTrace = DebugMng.trace_beforeNew;\n\t}\n\n\t// ログ出力\n\t#first = true;\n\t#log(hArg: TArg) {\n\t\tlet dat = '';\n\t\tif (this.#first) {\n\t\t\tthis.#first = false;\n\t\t\tdat = `== ${CmnLib.plat_desc} ==\\n`;\n\t\t}\n\t\tvoid this.sys.appendFile(\n\t\t\tthis.sys.path_downloads +'log.txt',\n\t\t\t`${dat}--- ${getDateStr('-', '_', '')\n\t\t\t} [fn:${DebugMng.#scrItr.scriptFn} line:${String(DebugMng.#scrItr.lineNum)\n\t\t\t}] prj:${this.sys.arg.cur\n\t\t\t// eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n\t\t\t}\\n${hArg.text || `(text is ${String(hArg.text)})`}\\n`,\n\t\t);\n\n\t\treturn false;\n\t}\n\n\t#trace(hArg: TArg) {\n\t\t// eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n\t\tDebugMng.myTrace(hArg.text || `(text is ${String(hArg.text)})`, 'I');\n\n\t\treturn false;\n\t}\n\n\t// private禁止、galleryでエラーになる\n\tstatic readonly trace_beforeNew: T_TRACE = (txt, lvl = 'E')=> {\n\t\tlet mes = `{${lvl}} `+ txt;\n\t\tlet sty = '';\n\t\tswitch (lvl) {\n\t\t\tcase 'D':\tsty = `color:#${CmnLib.isDarkMode ?'49F' :'05A'};`;\tbreak;\n\t\t\tcase 'W':\tsty = 'color:#FF8800;';\tbreak;\n\t\t\tcase 'F':\tsty = 'color:#BB0000;';\tbreak;\n\t\t\tcase 'ET':\tthrow mes;\n\t\t\tcase 'E':\tconsole.error('%c'+ mes, 'color:#FF3300;');\treturn;\n\t\t\tdefault:\tsty = 'color:black;';\tmes = ' '+ mes;\n\t\t}\n\t\tconsole.info('%c'+ mes, sty);\n\t}\n\tstatic myTrace = DebugMng.trace_beforeNew;\n\tstatic strPos = ()=> DebugMng.#scrItr.lineNum > 0\n\t\t? `(fn:${DebugMng.#scrItr.scriptFn} line:${String(DebugMng.#scrItr.lineNum)}) `\n\t\t: '';\n\tstatic readonly\t#st_trace: T_TRACE = (txt, lvl = 'E')=> {\n\t\tlet mes = `{${lvl}} `+ DebugMng.strPos() + txt;\n\t\tDebugMng.#dspDbg(mes, lvl);\n\n\t\tlet sty = '';\n\t\tswitch (lvl) {\n\t\t\tcase 'D':\tsty = `color:#${CmnLib.isDarkMode ?'49F' :'05A'};`;\tbreak;\n\t\t\tcase 'W':\tsty = 'color:#F80;';\tbreak;\n\t\t\tcase 'F':\tsty = 'color:#B00;';\tbreak;\n\t\t\tcase 'ET':\n\t\t\tcase 'E':\tDebugMng.#title({text: txt});\n\t\t\t\t/*if (CmnLib.osName === \"AND\") {\n\t\t\t\t\tconst buf = \"mailto:foo@hoge.co.jp\"\n\t\t\t\t\t\t+ \"?subject=AIRNovel_ERR&body=\"\n\t\t\t\t\t\t+ CmnLib.escapeZenkaku(mes) + \"\\n\"\n\t\t\t\t\t\t+ \"※一部記号は全角表示しています。\";\n\t\t\t\t\tflash.net.navigateToURL(new URLRequest(buf));\n\t\t\t\t}*/\n\t\t\t\tthis.#hTag.dump_lay({});\n\t\t\t\tthis.#hTag.dump_val({});\n\t\t\t\tDebugMng.#scrItr.dumpErrForeLine();\n\t\t\t\tthis.#hTag.dump_stack({});\n\n\t\t\t\tif (lvl === 'ET') throw mes;\n\t\t\t\tconsole.error('%c'+ mes, 'color:#F30;');\treturn;\n\t\t\tdefault:\tsty = '';\tmes = ' '+ mes;\n\t\t}\n\t\tconsole.info('%c'+ mes, sty);\n\t}\n\n\tstatic readonly\t#dspDbg: T_TRACE = (mes, lvl)=> {\n\t\tlet sty = '';\n\t\tswitch (lvl) {\n\t\t\tcase 'D':\tsty = 'color:#05A;';\tbreak;\n\t\t\tcase 'W':\tsty = 'color:#F80;';\tbreak;\n\t\t\tcase 'F':\tsty = 'color:#B00;';\tbreak;\n\t\t\tcase 'ET':\n\t\t\tcase 'E':\tsty = 'color:#F30;';\tbreak;\n\t\t\tdefault:\tsty = '';\n\t\t}\n\t\tDebugMng.#spnDbg.innerHTML += `<span style='${sty}'>${mes}</span><br/>`;\n\t\tDebugMng.#spnDbg.hidden = false;\n\t};\n\n}\n"],"names":["DebugMng","sys","hTag","scrItr","#scrItr","#hTag","#title","#st_trace","o","#log","#trace","#spnDbg","#first","hArg","dat","CmnLib","getDateStr","txt","lvl","mes","sty","#dspDbg"],"mappings":"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"}