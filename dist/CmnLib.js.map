{"version":3,"file":"CmnLib.js","names":["#ac"],"sources":["../src/sn/CmnLib.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2025 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport type {TArg} from './Grammar';\n\n// =============== Global\nexport function int(o: unknown): number {return parseInt(String(o), 10)}\nexport function uint(o: unknown): number {\n\tconst v = parseInt(String(o), 10);\n\treturn v < 0 ? -v : v;\n}\n\nexport function getDateStr(spl_dd = '/', spl_dt = ' ', spl_tt = ':', spl_ms = ''): string {\n\tconst now = new Date;\n\treturn String(now.getFullYear())\n\t\t+ spl_dd+ String(100 +now.getMonth() +1).slice(1, 3)\n\t\t+ spl_dd+ String(100 +now.getDate()).slice(1, 3)\n\t\t+ spl_dt+ String(100 +now.getHours()).slice(1, 3)\n\t\t+ spl_tt+ String(100 +now.getMinutes()).slice(1, 3)\n\t\t+ (spl_ms === '' ?'' :spl_ms+ String(now.getMilliseconds()));\n}\n\n\nconst\tcss_key4del\t= '/* SKYNovel */';\nexport function initStyle() {\n\t// eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\tconst he = document.getElementsByTagName('head')[0]!;\n\tconst len = he.children.length;\n\tfor (let i=len -1; i>=0; --i) {\n\t\tconst v = he.children[i];\n\t\tif (! (v instanceof HTMLStyleElement)) continue;\n\t\tif (! v.innerText.startsWith(css_key4del)) continue;\n\t\the.removeChild(v);\n\t}\n}\nexport function addStyle(style: string) {\n\tconst gs = document.createElement('style');\n\tgs.innerHTML = css_key4del + style;\n\t// eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\tdocument.getElementsByTagName('head')[0]!.appendChild(gs);\n}\n\n\n\n// =============== EventMng\nexport const EVNM_BUTTON= 'pointerdown';\nexport const EVNM_CLICK\t= 'pointerdown';\nexport const EVNM_KEY\t= 'keydown';\n\nimport type {Container} from 'pixi.js';\nexport type IEvtMng = {\n\tbutton(hArg: TArg, ctnBtn: Container, normal: ()=> void, hover: ()=> boolean, clicked: ()=> void): void;\n\tunButton(em: Container): void;\n\tget\tisSkipping(): boolean;\n\thideHint(): void;\n\tcvsResize(): void;\n\n\tresvFlameEvent(body: HTMLBodyElement): void;\n}\n\n\n\n// =============== ScriptIterator\nexport\tconst\tRPN_COMP_CHIN = 'compChIn';\n\n\n\ntype T_HASH_Arg = {\n\t':タグ名'?\t: string;\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t[name: string]: any;\n};\n\nexport\tfunction argChk_Num(hash: T_HASH_Arg, name: string, def: number): number {\n\t// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n\tconst v = hash[name];\n\tif (! (name in hash)) {\n\t\tif (isNaN(def)) throw `[${hash[':タグ名'] ?? ''}]属性 ${name} は必須です`;\n\n\t\thash[name] = def;\n\t\treturn def;\n\t}\n\n\tconst n = String(v).startsWith('0x')\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\t? parseInt(v)\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n\t\t: parseFloat(v);\n\tif (isNaN(n)) throw `[${hash[':タグ名'] ?? ''}]属性 ${name} の値【${String(v)}】が数値ではありません`;\n\n\thash[name] = n;\n\treturn n;\n}\n\n/*\n\tそれぞれの型を Boolean 型に変換した場合の値は以下のようになります。\n\n\tUndefiend \tfalse\n\tNull \t\tfalse\n\tBoolean \t変換前のオブジェクトと同じ\n\tNumber \t\t0 または NaN は false それ以外の値は true\n\tString \t\t空文字列は false  それ以外の値は true\n\tObject \t\ttrue\n*/\nexport\tfunction argChk_Boolean(hash: T_HASH_Arg, name: string, def: boolean): boolean {\n\t//\tt-r-a-c-e(Boolean(null),Boolean(\"\"),Boolean(undefined),Boolean(\"0\"),Boolean(\"1\"),Boolean(\"true\"),Boolean(\"false\"),Boolean(\"あい\"));\n\t//\t[exec] false false false true true true true true\n\t/*console.log('%o %o %o %o %o %o %o %o',\n\t\tBoolean(null), Boolean(\"\"), Boolean(undefined), Boolean(\"0\"), Boolean(\"1\"),\n\t\tBoolean(\"true\"), Boolean(\"false\"), Boolean(\"あい\"));\n\t*/\n\n\t//if (! hArg[name]) return hArg[name] = def;\n\tif (! (name in hash)) {hash[name] = def; return def;}\n\n\t// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n\tconst v = hash[name];\n\tif (v === null) return false;\n\n\tconst v2 = String(v);\n\tconst ret = hash[name] = v2 === 'false'? false : Boolean(v2);\n\treturn ret;\n}\n\n\nexport function parseColor(v: string): number {\n\tif (v.startsWith('#')) return parseInt(v.slice(1), 16);\n\tconst n = Number(v);\n\tif (! isNaN(n)) return n;\t// 0, 0xffffff\n\n\tif (v === 'black') return 0;\n\tCmnLib.cc4ColorName.fillStyle = v;\n\tconst cc = CmnLib.cc4ColorName.fillStyle;\n\tif (cc === '#000000') throw `色名前 ${v} が異常です`;\n\n\treturn parseInt(cc.slice(1), 16);\n}\nexport\tfunction argChk_Color(hash: T_HASH_Arg, name: string, def: number): number {\n\t// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n\tconst v = hash[name];\n\tif (! v) {hash[name] = def; return def;}\n\n\tconst ret = hash[name] = parseColor(String(v));\n\treturn ret;\n}\n\n\nconst REG_ERRMES_JSON = /JSON at position (\\d+)$/;\n\t// Unexpected number in JSON at position\nexport\tfunction mesErrJSON(hArg: TArg, nm = '', mes = ''): string {\n\tconst col = (REG_ERRMES_JSON.exec(mes) ?? ['',''])[1];\n\treturn `[${hArg[':タグ名'] ?? ''}] ${nm} 属性の解析エラー : ${mes}\n${\n\t// eslint-disable-next-line @typescript-eslint/no-base-to-string\n\tString(hArg[<keyof TArg>nm])\n}${col ?`\n${'^'.padStart(Number(col))}` :''}`;\n}\n\n\nconst REG_FN\t= /^[^/.]+$|[^/]+(?=\\.)/;\n\t// https://regex101.com/r/8sltIm/1\nexport\tfunction getFn(p: string) {return (REG_FN.exec(p) ?? [''])[0]}\n\nexport type T_DIP = {[name: string]: string};\n\n//import {isMobile} from 'pixi.js';\t\t// 使い物にならないことを確認済み\n// eslint-disable-next-line @typescript-eslint/no-extraneous-class\nexport class CmnLib {\n\tstatic\tasync\tinit() {\n\t\tconst p = await import('platform');\n\t\tthis.platform\t= JSON.stringify(p);\n\t\tthis.plat_desc\t= p.description ?? '';\n\t\tthis.isSafari\t= p.name === 'Safari';\n\t\tthis.isFirefox\t= p.name === 'Firefox';\n\t\tthis.isMac\t\t= (p.os?.family ?? '').includes('OS X');\n\t\tthis.isMobile\t= ! /(Windows|OS X)/.test(p.os?.family ?? '');\n\t}\n\n\tstatic\tstageW\t\t= 0;\n\tstatic\tstageH\t\t= 0;\n\tstatic\tdebugLog\t= false;\n\tstatic\tplatform\t: string;\n\tstatic\tplat_desc\t: string;\n\tstatic\tisSafari\t: boolean;\n\tstatic\tisFirefox\t: boolean;\n\tstatic\tisMac\t\t: boolean;\n\tstatic\tisMobile\t: boolean;\n\tstatic\thDip\t\t: T_DIP\t= {};\n\tstatic\tisDbg\t\t= false;\n\tstatic\tisPackaged\t= false;\n\n\tstatic\tneedClick2Play(): boolean {\n\t\tif ('AudioContext' in globalThis) {\n\t\t\tCmnLib.#ac = new globalThis.AudioContext;\n\t\t\tCmnLib.needClick2Play = ()=> CmnLib.#ac.state === 'suspended';\n\t\t}\n\t\telse CmnLib.needClick2Play = ()=> false;\n\n\t\treturn CmnLib.needClick2Play();\n\t}\n\tstatic\t#ac: AudioContext;\n\n\tstatic\tisDarkMode\t= false;\n\n\tstatic\tcc4ColorName: CanvasRenderingContext2D;\n\n}\n"],"mappings":"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"}